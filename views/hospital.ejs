<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Dashboard - RaktSetu</title>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .nav-link {
            position: relative;
            transition: color 0.3s ease;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 0;
            background-color: #1d4ed8;
            transition: width 0.3s ease;
        }

        .nav-link:hover::after,
        .nav-link.active::after {
            width: 100%;
        }

        .nav-link.active {
            color: #1d4ed8;
            font-weight: 500;
        }

        .blood-group {
            transition: all 0.3s ease;
        }

        .blood-group:hover {
            transform: scale(1.05);
        }

        .request-card {
            transition: all 0.3s ease;
        }

        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-accepted {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .status-completed {
            background-color: #dbeafe;
            color: #1e40af;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .search-input {
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="min-h-screen" x-data="hospitalDashboard()" x-init="init()">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-hospital text-blue-600 text-2xl mr-2"></i>
                        <span class="text-xl font-bold text-gray-800">RaktSetu - Hospital</span>
                    </div>
                    <div class="hidden md:ml-10 md:flex md:space-x-8">
                        <a href="/hospital/<%= user._id %>" class="nav-link active text-gray-900">Dashboard</a>
                        <a href="/hospital/<%= user._id %>/requests" class="nav-link text-gray-500 hover:text-gray-700">Requests</a>
                        <a href="#reports" class="nav-link text-gray-500 hover:text-gray-700">Reports</a>
                    </div>
                </div>
                <div class="hidden md:ml-4 md:flex md:items-center">
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="flex items-center max-w-xs rounded-full focus:outline-none">
                            <span class="ml-2 text-sm font-medium text-gray-700"><%= user.hospitalName %></span>
                            <i class="fas fa-chevron-down ml-1 text-gray-500 text-xs"></i>
                        </button>
                        <div x-show="open" @click.away="open = false" class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                            <div class="py-1">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-cog mr-2"></i>Settings
                                </a>
                                <a href="#" @click="showUpdateStockModal = true" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-plus-circle mr-2"></i>Update Stock
                                </a>
                                <a href="#" @click="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Sign out
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="-mr-2 flex items-center md:hidden">
                    <button @click="mobileMenuOpen = !mobileMenuOpen" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none">
                        <span class="sr-only">Open main menu</span>
                        <i x-show="!mobileMenuOpen" class="fas fa-bars h-6 w-6"></i>
                        <i x-show="mobileMenuOpen" class="fas fa-times h-6 w-6"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div x-show="mobileMenuOpen" @click.away="mobileMenuOpen = false" class="md:hidden">
            <div class="pt-2 pb-3 space-y-1">
                <a href="/hospital/<%= user._id %>" class="bg-blue-50 border-blue-500 text-blue-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Dashboard</a>
                <a href="/hospital/<%= user._id %>/requests" class="border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Requests</a>
                <a href="#reports" class="border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Reports</a>
                <a href="#" @click="showUpdateStockModal = true" class="border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Update Stock</a>
                <a href="#" @click="logout()" class="border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Sign out</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Welcome Banner -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white mb-8 animate-fade-in">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold mb-2">Welcome back, <%= user.hospitalName %></h1>
                    <p class="opacity-90">Manage blood requests and donations efficiently</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <button @click="showUpdateStockModal = true" class="bg-white text-blue-600 hover:bg-blue-50 px-6 py-2 rounded-lg font-medium transition duration-200 flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Update Blood Stock
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Requests -->
            <div class="glass-card rounded-xl p-6 flex items-center">
                <div class="p-3 bg-blue-100 rounded-full mr-4">
                    <i class="fas fa-tint text-blue-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Total Blood Requests</p>
                    <h3 class="text-2xl font-bold text-gray-800" x-text="totalRequests">0</h3>
                </div>
            </div>
            <!-- Pending Requests -->
            <div class="glass-card rounded-xl p-6 flex items-center">
                <div class="p-3 bg-yellow-100 rounded-full mr-4">
                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Pending Requests</p>
                    <h3 class="text-2xl font-bold text-gray-800" x-text="pendingRequests">0</h3>
                </div>
            </div>
            <!-- Available Blood Units -->
            <div class="glass-card rounded-xl p-6 flex items-center">
                <div class="p-3 bg-green-100 rounded-full mr-4">
                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Available Blood Units</p>
                    <h3 class="text-2xl font-bold text-gray-800" x-text="totalBloodUnits">0</h3>
                </div>
            </div>
            <!-- Critical Stock -->
            <div class="glass-card rounded-xl p-6 flex items-center">
                <div class="p-3 bg-red-100 rounded-full mr-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Critical Stock</p>
                    <h3 class="text-2xl font-bold text-gray-800" x-text="criticalStockCount">0</h3>
                </div>
            </div>
        </div>

        <!-- Blood Requests Section -->
        <div class="glass-card rounded-xl p-6 mb-8" x-data="bloodRequests">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Incoming Blood Requests for <span x-text="currentHospitalName"></span></h2>
                <button @click="fetchRequests" class="text-blue-600 hover:text-blue-800" :disabled="isLoading">
                    <i class="fas fa-sync-alt" :class="{'animate-spin': isLoading}"></i>
                    <span class="ml-1">Refresh</span>
                </button>
            </div>
            
            <!-- Loading State -->
            <div x-show="isLoading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
                <p class="mt-2 text-gray-600">Loading requests...</p>
            </div>
            
            <!-- Error State -->
            <div x-show="error && !isLoading" class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700" x-text="error"></p>
                        <button @click="fetchRequests" class="mt-2 text-sm text-red-600 hover:text-red-800 font-medium">
                            Try again
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- No Requests -->
            <div x-show="!isLoading && !error && requests.length === 0" class="text-center py-8">
                <i class="fas fa-inbox text-gray-400 text-4xl mb-2"></i>
                <p class="text-gray-500">No incoming blood requests</p>
                <p class="text-sm text-gray-400 mt-1">Requests from other hospitals will appear here</p>
            </div>
            
            <!-- Requests List -->
            <div class="space-y-4">
                <template x-for="request in requests" :key="request._id">
                    <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-100 hover:shadow-md transition-shadow duration-200">
                        <div class="p-5">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between">
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900">
                                                <template x-if="isValidHospitalName(request.sourceHospitalName)">
                                                    <span x-text="'Request from: ' + request.sourceHospitalName"></span>
                                                </template>
                                                <template x-if="!isValidHospitalName(request.sourceHospitalName)">
                                                    <span>New Blood Request Received</span>
                                                </template>
                                            </h3>
                                            <p class="text-sm text-gray-500 mt-1" x-text="'Request ID: ' + request._id"></p>
                                        </div>
                                        <span 
                                            x-text="request.status.charAt(0).toUpperCase() + request.status.slice(1)"
                                            :class="{
                                                'bg-yellow-100 text-yellow-800': request.status === 'pending',
                                                'bg-green-100 text-green-800': request.status === 'approved',
                                                'bg-red-100 text-red-800': request.status === 'rejected',
                                                'px-3 py-1 rounded-full text-xs font-medium': true
                                            }"
                                        ></span>
                                    </div>
                                    
                                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="bg-blue-50 p-3 rounded-lg">
                                            <p class="text-xs font-medium text-blue-700 uppercase tracking-wider">Blood Group</p>
                                            <p class="text-lg font-bold text-blue-900" x-text="request.bloodGroup || 'N/A'"></p>
                                        </div>
                                        
                                        <div class="bg-green-50 p-3 rounded-lg">
                                            <p class="text-xs font-medium text-green-700 uppercase tracking-wider">Units</p>
                                            <p class="text-lg font-bold text-green-900" x-text="request.units || '0'"></p>
                                        </div>
                                        
                                        <div class="bg-purple-50 p-3 rounded-lg">
                                            <p class="text-xs font-medium text-purple-700 uppercase tracking-wider">Priority</p>
                                            <p class="text-lg font-bold text-purple-900 capitalize" x-text="request.priority || 'Medium'"></p>
                                        </div>
                                        
                                        <div class="bg-amber-50 p-3 rounded-lg">
                                            <p class="text-xs font-medium text-amber-700 uppercase tracking-wider">Requested On</p>
                                            <p class="text-sm font-medium text-amber-900" x-text="formatDate(request.datetime)"></p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <div class="flex items-center text-sm text-gray-600">
                                            <i class="fas fa-user-circle text-gray-400 mr-2"></i>
                                            <span x-text="request.contactPerson || 'No contact person'"></span>
                                            <span class="mx-2 text-gray-300">•</span>
                                            <i class="fas fa-phone-alt text-gray-400 mr-2"></i>
                                            <span x-text="request.contactNumber || 'No contact number'"></span>
                                        </div>
                                    </div>
                                    
                                    <template x-if="request.notes">
                                        <div class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-100">
                                            <p class="text-sm font-medium text-gray-700 mb-1">Additional Notes</p>
                                            <p class="text-sm text-gray-600" x-text="request.notes"></p>
                                        </div>
                                    </template>
                                    
                                    <!-- Action Buttons -->
                                    <div class="mt-4 flex flex-wrap gap-2" x-show="request.status === 'pending'">
                                        <button 
                                            @click="confirmStatusUpdate(request._id, 'approved')"
                                            class="flex-1 md:flex-none flex items-center justify-center px-4 py-2 bg-green-100 text-green-700 text-sm font-medium rounded-md hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                                            :disabled="isUpdating"
                                        >
                                            <i class="fas fa-check mr-2"></i>
                                            <span>Approve</span>
                                        </button>
                                        <button 
                                            @click="confirmStatusUpdate(request._id, 'rejected')"
                                            class="flex-1 md:flex-none flex items-center justify-center px-4 py-2 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                                            :disabled="isUpdating"
                                        >
                                            <i class="fas fa-times mr-2"></i>
                                            <span>Reject</span>
                                        </button>
                                        <button 
                                            @click=""
                                            class="flex-1 md:flex-none flex items-center justify-center px-4 py-2 bg-blue-100 text-blue-700 text-sm font-medium rounded-md hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                            :disabled="isUpdating"
                                        >
                                            <i class="fas fa-phone-alt mr-2"></i>
                                            <span>Call Now</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Blood Stock Overview -->
        <div class="glass-card rounded-xl p-6 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Blood Stock Overview</h2>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input 
                            type="text" 
                            placeholder="Search blood groups..." 
                            class="search-input pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            x-model="bloodSearch"
                            @input="filterBloodGroups"
                        >
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button 
                        @click="updateAllBloodStock()"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 flex items-center space-x-2"
                        :disabled="isUpdating"
                        title="Save all blood stock changes"
                    >
                        <i class="fas fa-save" :class="{'animate-pulse': isUpdating}"></i>
                        <span x-text="isUpdating ? 'Saving...' : 'Save All Stock'"></span>
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-4" id="bloodStockContainer">
                <template x-for="(stock, group) in bloodStock" :key="group">
                    <div class="blood-group bg-white p-4 rounded-lg shadow text-center transform transition-all duration-300 hover:shadow-lg"
                         :class="{'border-2 border-red-500': stock.units < 5}">
                        <div class="text-2xl font-bold" 
                             :class="{'text-red-600': stock.units < 5, 'text-blue-600': stock.units >= 5}"
                             x-text="group"></div>
                        <div class="text-lg font-medium text-gray-700" x-text="stock.units"></div>
                        <div class="text-xs text-gray-500">units available</div>
                        <div x-show="stock.units < 5" class="text-xs text-red-500 mt-1">Low stock!</div>
                    </div>
                </template>
            </div>
        </div>

            </div>
        </div>

        <!-- Request Blood from Other Hospitals -->
        <div id="request-blood" class="glass-card rounded-xl p-6 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Request Blood from Other Hospitals</h2>
            </div>
            
            <!-- Search Filters -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="searchState" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <select 
                            id="searchState" 
                            x-model="searchFilters.state"
                            @change="fetchCities()"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">Select State</option>
                            <template x-for="state in states" :key="state">
                                <option :value="state" x-text="state"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label for="searchCity" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                        <select 
                            id="searchCity" 
                            x-model="searchFilters.city"
                            :disabled="!searchFilters.state"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50"
                        >
                            <option value="">Select City</option>
                            <template x-for="city in filteredCities" :key="city">
                                <option :value="city" x-text="city"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label for="searchBloodGroup" class="block text-sm font-medium text-gray-700 mb-1">Blood Group</label>
                        <select 
                            id="searchBloodGroup" 
                            x-model="searchFilters.bloodGroup"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">Select Blood Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button 
                            @click="searchHospitals()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 flex items-center justify-center"
                            :disabled="!searchFilters.bloodGroup || (!searchFilters.state && !searchFilters.city)"
                            :class="{'opacity-50 cursor-not-allowed': !searchFilters.bloodGroup || (!searchFilters.state && !searchFilters.city)}"
                        >
                            <i class="fas fa-search mr-2"></i> Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search Results -->
            <div x-show="isLoading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2 text-gray-600">Searching for hospitals...</p>
            </div>

            <div x-show="searchResults.length > 0" class="mt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <span x-text="searchResults.length"></span> Hospitals Found
                        <span x-show="searchFilters.city || searchFilters.state">
                            in <span x-text="searchFilters.city || searchFilters.state"></span>
                        </span>
                    </h3>
                    <div class="flex space-x-2">
                        <button 
                            @click="showMap = !showMap" 
                            class="px-3 py-1.5 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center"
                        >
                            <i class="fas" :class="showMap ? 'fa-list' : 'fa-map-marker-alt'"></i>
                            <span class="ml-2" x-text="showMap ? 'List View' : 'Map View'"></span>
                        </button>
                    </div>
                </div>

                <!-- Map View -->
                <div x-show="showMap" class="mb-6 h-96 rounded-lg overflow-hidden border border-gray-200">
                    <div id="map" class="w-full h-full"></div>
                    <style>
                        .leaflet-popup-content-wrapper {
                            border-radius: 8px;
                            padding: 0;
                            overflow: hidden;
                        }
                        .leaflet-popup-content {
                            margin: 0;
                            width: 250px !important;
                        }
                        .leaflet-popup-content h4 {
                            margin: 0;
                            padding: 10px 15px;
                            background: #3b82f6;
                            color: white;
                            font-size: 14px;
                            font-weight: 600;
                        }
                        .leaflet-popup-content .popup-content {
                            padding: 10px 15px;
                        }
                        .leaflet-popup-content .popup-footer {
                            padding: 8px 15px;
                            background: #f8fafc;
                            border-top: 1px solid #e2e8f0;
                            display: flex;
                            justify-content: flex-end;
                        }
                    </style>
                </div>

                <!-- List View -->
                <div x-show="!showMap" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="hospital in searchResults" :key="hospital.place_id">
                        <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 hover:shadow-lg transition-shadow duration-200">
                            <div class="p-5">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 bg-blue-100 rounded-full p-3">
                                        <i class="fas fa-hospital text-blue-600 text-xl"></i>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <h4 class="text-lg font-semibold text-gray-900" x-text="hospital.name"></h4>
                                        
                                        <div class="mt-2 flex items-center text-sm text-gray-600">
                                            <i class="fas fa-star text-yellow-400 mr-1"></i>
                                            <span x-text="hospital.rating || 'N/A'"></span>
                                            <span class="mx-1">•</span>
                                            <span x-text="hospital.user_ratings_total ? hospital.user_ratings_total + ' reviews' : 'No reviews'"></span>
                                        </div>

                                        <div class="mt-3 flex items-center">
                                            <span class="text-sm font-medium text-gray-700">Blood Group:</span>
                                            <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                                                <span x-text="searchFilters.bloodGroup"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200 flex space-x-2">
                                    <a 
                                        :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(hospital.name + ' ' + (hospital.vicinity || hospital.formatted_address))"
                                        target="_blank"
                                        class="flex-1 text-center px-3 py-2 bg-white border border-gray-300 text-sm font-medium rounded-lg text-gray-700 hover:bg-gray-50 flex items-center justify-center"
                                    >
                                        <i class="fas fa-directions mr-2"></i>
                                        <span>Directions</span>
                                    </a>
                                    <button 
                                        @click="openRequestModal(hospital)"
                                        class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 flex items-center"
                                    >
                                        <i class="fas fa-tint mr-2"></i>
                                        <span>Request Blood</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- No Results Message -->
            <div x-show="searchPerformed && searchResults.length === 0" class="text-center py-8">
                <i class="fas fa-search text-gray-400 text-4xl mb-3"></i>
                <p class="text-gray-600">No hospitals found matching your criteria. Try adjusting your search filters.</p>
            </div>

            <!-- Request Blood Modal -->
            <div x-show="showRequestModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4" style="display: none;">
                <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto" @click.away="showRequestModal = false">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Request Blood from <span x-text="selectedHospital?.name"></span></h3>
                            <button @click="showRequestModal = false" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                        <form @submit.prevent="submitRequest">
                            <div class="space-y-4">
                                <!-- Hospital and Blood Group Info -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-700 mb-1">
                                        <span class="font-medium">Hospital:</span> 
                                        <span x-text="selectedHospital?.name" class="font-semibold"></span>
                                    </p>
                                    <p class="text-sm text-gray-700">
                                        <span class="font-medium">Blood Group:</span> 
                                        <span class="font-semibold" x-text="searchFilters.bloodGroup"></span>
                                    </p>
                                </div>

                                <!-- Request Form -->
                                <div class="space-y-4">
                                    <!-- Units Needed -->
                                    <div class="relative">
                                        <label for="requestUnits" class="block text-sm font-medium text-gray-700 mb-1">Number of Units <span class="text-red-500">*</span></label>
                                        <div class="relative flex items-center">
                                            <button 
                                                type="button" 
                                                @click="requestUnits > 1 ? requestUnits-- : null" 
                                                class="absolute left-0 top-0 bottom-0 px-3 text-gray-500 hover:text-gray-700"
                                                :disabled="requestUnits <= 1"
                                            >
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input 
                                                type="number" 
                                                id="requestUnits" 
                                                x-model="requestUnits"
                                                min="1"
                                                class="w-full border border-gray-300 rounded-lg px-10 py-2 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                required
                                            >
                                            <button 
                                                type="button" 
                                                @click="requestUnits++" 
                                                class="absolute right-0 top-0 bottom-0 px-3 text-gray-500 hover:text-gray-700"
                                            >
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Contact Information -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="contactPerson" class="block text-sm font-medium text-gray-700 mb-1">Contact Person <span class="text-red-500">*</span></label>
                                            <input 
                                                type="text" 
                                                id="contactPerson" 
                                                x-model="contactPerson"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="Full name"
                                                required
                                            >
                                        </div>
                                        <div>
                                            <label for="contactNumber" class="block text-sm font-medium text-gray-700 mb-1">Contact Number <span class="text-red-500">*</span></label>
                                            <input 
                                                type="tel" 
                                                id="contactNumber" 
                                                x-model="contactNumber"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="Phone number"
                                                required
                                            >
                                        </div>
                                    </div>

                                    <!-- Priority -->
                                    <div>
                                        <label for="requestPriority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                        <select 
                                            id="requestPriority" 
                                            x-model="requestPriority"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        >
                                            <option value="low">Low</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                    </div>

                                    <!-- Additional Notes -->
                                    <div>
                                        <label for="requestNotes" class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                                        <textarea 
                                            id="requestNotes" 
                                            x-model="requestNotes"
                                            rows="3"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="Any additional information about this request..."
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end space-x-3">
                                <button 
                                    type="button" 
                                    @click="showRequestModal = false"
                                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Cancel
                                </button>
                                <button 
                                    type="submit" 
                                    class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                                    :disabled="isSubmitting || !requestUnits || !contactPerson || !contactNumber"
                                >
                                    <span x-text="isSubmitting ? 'Submitting...' : 'Submit Request'"></span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Update Stock Modal -->
    <div x-show="showUpdateStockModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4" style="display: none;">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto" @click.away="showUpdateStockModal = false">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Update Blood Stock</h3>
                    <button @click="showUpdateStockModal = false" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form @submit.prevent="updateBloodStock">
                    <div class="space-y-4">
                        <div>
                            <label for="bloodGroup" class="block text-sm font-medium text-gray-700 mb-1">Blood Group</label>
                            <select 
                                id="bloodGroup" 
                                x-model="newStock.bloodGroup"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                required
                            >
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div>
                            <label for="units" class="block text-sm font-medium text-gray-700 mb-1">Units to Add/Remove</label>
                            <div class="relative">
                                <button 
                                    type="button" 
                                    @click="newStock.units = Math.max(0, newStock.units - 1)" 
                                    class="absolute left-0 top-0 bottom-0 px-3 text-gray-500 hover:text-gray-700"
                                >
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input 
                                    type="number" 
                                    id="units" 
                                    x-model="newStock.units"
                                    min="0"
                                    class="w-full border border-gray-300 rounded-lg px-10 py-2 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                >
                                <button 
                                    type="button" 
                                    @click="newStock.units++" 
                                    class="absolute right-0 top-0 bottom-0 px-3 text-gray-500 hover:text-gray-700"
                                >
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Use + and - buttons or type the number of units</p>
                        </div>
                        <div>
                            <label for="action" class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                            <select 
                                id="action" 
                                x-model="newStock.action"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                required
                            >
                                <option value="add">Add to Stock</option>
                                <option value="remove">Remove from Stock</option>
                            </select>
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                            <textarea 
                                id="notes" 
                                x-model="newStock.notes"
                                rows="2"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Any additional information about this update"
                            ></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button 
                            type="button" 
                            @click="showUpdateStockModal = false"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        >
                            Update Stock
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Donation Modal -->
    <div x-show="showDonationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4" style="display: none;">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto" @click.away="closeDonationModal">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900" x-text="editingDonation ? 'Edit Donation' : 'Add New Donation'"></h3>
                    <button @click="closeDonationModal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form @submit.prevent="saveDonation">
                    <div class="space-y-4">
                        <div>
                            <label for="donorName" class="block text-sm font-medium text-gray-700 mb-1">Donor Name</label>
                            <input 
                                type="text" 
                                id="donorName" 
                                x-model="donationForm.donorName"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter donor's name"
                            >
                        </div>
                        <div>
                            <label for="donorBloodGroup" class="block text-sm font-medium text-gray-700 mb-1">Blood Group</label>
                            <select 
                                id="donorBloodGroup" 
                                x-model="donationForm.bloodGroup"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                required
                            >
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="donationDate" class="block text-sm font-medium text-gray-700 mb-1">Donation Date</label>
                                <input 
                                    type="date" 
                                    id="donationDate" 
                                    x-model="donationForm.donationDate"
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                >
                            </div>
                            <div>
                                <label for="donationUnits" class="block text-sm font-medium text-gray-700 mb-1">Units</label>
                                <input 
                                    type="number" 
                                    id="donationUnits" 
                                    x-model="donationForm.units"
                                    min="1"
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                >
                            </div>
                        </div>
                        <div>
                            <label for="donationNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                            <textarea 
                                id="donationNotes" 
                                x-model="donationForm.notes"
                                rows="2"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Any additional information about this donation"
                            ></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button 
                            type="button" 
                            @click="closeDonationModal"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        >
                            <span x-text="editingDonation ? 'Update Donation' : 'Add Donation'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div x-show="showConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4" style="display: none;">
        <div class="bg-white rounded-xl max-w-md w-full p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fas fa-exclamation text-red-600 text-xl"></i>
                </div>
                <h3 class="mt-3 text-lg font-medium text-gray-900" x-text="confirmTitle"></h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500" x-text="confirmMessage"></p>
                </div>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button 
                        type="button" 
                        @click="confirmAction()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:col-start-2 sm:text-sm"
                    >
                        Confirm
                    </button>
                    <button 
                        type="button" 
                        @click="showConfirmModal = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:col-start-1 sm:text-sm"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function hospitalDashboard() {
            return {
                // Store current hospital name from the welcome banner
                currentHospitalName: '<%= user.hospitalName %>',
                // UI State
                mobileMenuOpen: false,
                showUpdateStockModal: false,
                showDonationModal: false,
                showRequestModal: false,
                selectedHospital: null,
                requestUnits: 1,
                contactPerson: '',
                contactNumber: '',
                requestPriority: 'medium',
                requestNotes: '',
                isUpdating: false,
                showConfirmModal: false,
                showRequestModal: false,
                isLoading: false,
                
                // Form Data
                newStock: {
                    bloodGroup: '',
                    units: 1,
                    action: 'add',
                    notes: ''
                },
                
                // Confirmation Dialog
                confirmTitle: '',
                confirmMessage: '',
                confirmAction: () => {},
                
                // Search and Filters
                bloodSearch: '',
                requestFilter: 'all',
                searchQuery: '',
                searchFilters: {
                    bloodGroup: '',
                    state: '',
                    city: '',
                    distance: 10
                },
                searchResults: [],
                searchPerformed: false,
                
                // Blood Stock Data
                totalRequests: 0,
                pendingRequests: 0,
                totalBloodUnits: 0,
                criticalStockCount: 0,
                bloodStock: {
                    'A+': { units: 0 },
                    'A-': { units: 0 },
                    'B+': { units: 0 },
                    'B-': { units: 0 },
                    'AB+': { units: 0 },
                    'AB-': { units: 0 },
                    'O+': { units: 0 },
                    'O-': { units: 0 }
                },
                bloodRequests: [],
                filteredRequests: [],

                async init() {
                    await this.fetchBloodStock();
                    await this.fetchBloodRequests();
                    this.calculateStats();
                },

                async fetchBloodStock() {
                    try {
                        const hospitalId = '<%= user._id %>';
                        const response = await fetch(`/api/hospitals/${hospitalId}/blood-stock`);
                        
                        if (!response.ok) {
                            throw new Error('Failed to fetch blood stock');
                        }
                        
                        const data = await response.json();
                        
                        // Update blood stock with server data
                        if (data && typeof data === 'object') {
                            // Ensure all blood groups are initialized
                            const defaultStock = {
                                'A+': { units: 0 },
                                'A-': { units: 0 },
                                'B+': { units: 0 },
                                'B-': { units: 0 },
                                'AB+': { units: 0 },
                                'AB-': { units: 0 },
                                'O+': { units: 0 },
                                'O-': { units: 0 }
                            };
                            
                            // Merge server data with default structure
                            this.bloodStock = { ...defaultStock, ...data };
                            
                            // Ensure each blood group has the correct structure
                            Object.keys(this.bloodStock).forEach(group => {
                                if (typeof this.bloodStock[group] === 'number') {
                                    this.bloodStock[group] = { units: this.bloodStock[group] };
                                } else if (!this.bloodStock[group] || typeof this.bloodStock[group] !== 'object') {
                                    this.bloodStock[group] = { units: 0 };
                                }
                            });
                            
                            // Recalculate stats after updating stock
                            this.calculateBloodStats();
                        }
                    } catch (error) {
                        console.error('Error fetching blood stock:', error);
                        // Initialize with default values if fetch fails
                        this.bloodStock = {
                            'A+': { units: 0 },
                            'A-': { units: 0 },
                            'B+': { units: 0 },
                            'B-': { units: 0 },
                            'AB+': { units: 0 },
                            'AB-': { units: 0 },
                            'O+': { units: 0 },
                            'O-': { units: 0 }
                        };
                        
                        // Calculate total blood units and critical stock count
                        this.calculateBloodStats();
                        this.showError('Failed to load blood stock data. Using default values.');
                    }
                },

                async fetchBloodRequests() {
                    try {
                        // Simulate API call - replace with actual API call
                        // const response = await fetch(`/api/requests/hospital/${this.userId}`);
                        // const data = await response.json();
                        // this.bloodRequests = data.requests;
                        
                        // For demo purposes, we'll use sample data
                        const sampleRequests = [
                            {
                                _id: '1',
                                patientName: 'John Doe',
                                bloodGroup: 'A+',
                                units: 2,
                                contactNumber: '+91 98765 43210',
                                email: 'john.doe@example.com',
                                status: 'pending',
                                createdAt: new Date(),
                                updatedAt: new Date()
                            },
                            {
                                _id: '2',
                                patientName: 'Jane Smith',
                                bloodGroup: 'B-',
                                units: 1,
                                contactNumber: '+91 98765 12345',
                                email: 'jane.smith@example.com',
                                status: 'accepted',
                                createdAt: new Date(Date.now() - 86400000),
                                updatedAt: new Date()
                            },
                            {
                                _id: '3',
                                patientName: 'Robert Johnson',
                                bloodGroup: 'O+',
                                units: 3,
                                contactNumber: '+91 98765 67890',
                                email: 'robert.j@example.com',
                                status: 'completed',
                                createdAt: new Date(Date.now() - 172800000),
                                updatedAt: new Date()
                            },
                            {
                                _id: '4',
                                patientName: 'Emily Davis',
                                bloodGroup: 'AB+',
                                units: 2,
                                contactNumber: '+91 98765 98765',
                                email: 'emily.d@example.com',
                                status: 'rejected',
                                reason: 'Insufficient stock',
                                createdAt: new Date(Date.now() - 259200000),
                                updatedAt: new Date()
                            }
                        ];
                        
                        this.bloodRequests = sampleRequests.map(request => ({
                            ...request,
                            createdAt: request.createdAt.toISOString(),
                            updatedAt: request.updatedAt.toISOString()
                        }));
                        
                        this.filteredRequests = [...this.bloodRequests];
                        this.calculateRequestStats();
                    } catch (error) {
                        console.error('Error fetching blood requests:', error);
                        this.showError('Failed to load blood requests');
                    }
                },

                calculateStats() {
                    this.calculateBloodStats();
                    this.calculateRequestStats();
                },

                calculateBloodStats() {
                    // Calculate total blood units
                    this.totalBloodUnits = Object.values(this.bloodStock).reduce(
                        (total, group) => total + (parseInt(group.units) || 0), 0
                    );
                    
                    // Calculate critical stock count (less than 5 units)
                    this.criticalStockCount = Object.values(this.bloodStock).filter(
                        group => group.units < 5
                    ).length;
                },

                calculateRequestStats() {
                    this.totalRequests = this.bloodRequests.length;
                    this.pendingRequests = this.bloodRequests.filter(
                        req => req.status === 'pending'
                    ).length;
                },

                filterBloodGroups() {
                    const searchTerm = this.bloodSearch.toLowerCase();
                    const container = document.getElementById('bloodStockContainer');
                    const groups = container.getElementsByClassName('blood-group');
                    
                    Array.from(groups).forEach(group => {
                        const groupName = group.textContent.trim().split('\n')[0];
                        if (groupName.toLowerCase().includes(searchTerm)) {
                            group.style.display = '';
                        } else {
                            group.style.display = 'none';
                        }
                    });
                },

                filterRequests() {
                    if (this.requestFilter === 'all') {
                        this.filteredRequests = [...this.bloodRequests];
                    } else {
                        this.filteredRequests = this.bloodRequests.filter(
                            req => req.status === this.requestFilter
                        );
                    }
                    
                    // Apply search query filter if any
                    this.searchRequests();
                },

                searchRequests() {
                    if (!this.searchQuery) {
                        this.filterRequests();
                        return;
                    }
                    
                    const query = this.searchQuery.toLowerCase();
                    this.filteredRequests = this.filteredRequests.filter(req => 
                        req.patientName.toLowerCase().includes(query) ||
                        req.bloodGroup.toLowerCase().includes(query) ||
                        req.contactNumber.includes(query) ||
                        (req.email && req.email.toLowerCase().includes(query))
                    );
                },

                async updateRequestStatus(requestId, status) {
                    try {
                        // Show confirmation for reject action
                        if (status === 'rejected') {
                            this.confirmTitle = 'Reject Request';
                            this.confirmMessage = 'Are you sure you want to reject this blood request?';
                            this.confirmAction = async () => {
                                await this.performStatusUpdate(requestId, status);
                                this.showConfirmModal = false;
                            };
                            this.showConfirmModal = true;
                            return;
                        }
                        
                        // For other status updates, proceed directly
                        await this.performStatusUpdate(requestId, status);
                    } catch (error) {
                        console.error('Error updating request status:', error);
                        this.showError('Failed to update request status');
                    }
                },

                async performStatusUpdate(requestId, status) {
                    try {
                        // Simulate API call - replace with actual API call
                        // const response = await fetch(`/api/requests/${requestId}/status`, {
                        //     method: 'PUT',
                        //     headers: {
                        //         'Content-Type': 'application/json',
                        //     },
                        //     body: JSON.stringify({ status })
                        // });
                        // 
                        // if (!response.ok) {
                        //     throw new Error('Failed to update status');
                        // }
                        
                        // For demo purposes, update the local state
                        const requestIndex = this.bloodRequests.findIndex(req => req._id === requestId);
                        if (requestIndex !== -1) {
                            this.bloodRequests[requestIndex].status = status;
                            this.bloodRequests[requestIndex].updatedAt = new Date().toISOString();
                            
                            // Update filtered requests to reflect the change
                            this.filterRequests();
                            
                            // Show success message
                            this.showSuccess(`Request ${status} successfully`);
                            
                            // If status is completed, update blood stock
                            if (status === 'completed') {
                                const request = this.bloodRequests[requestIndex];
                                this.updateLocalBloodStock(request.bloodGroup, -request.units);
                            }
                        }
                    } catch (error) {
                        console.error('Error performing status update:', error);
                        throw error;
                    }
                },

                // Initialize blood stock with default values if not exists
                ensureBloodStockInitialized() {
                    const defaultStock = {
                        'A+': { units: 0 },
                        'A-': { units: 0 },
                        'B+': { units: 0 },
                        'B-': { units: 0 },
                        'AB+': { units: 0 },
                        'AB-': { units: 0 },
                        'O+': { units: 0 },
                        'O-': { units: 0 }
                    };

                    // Initialize any missing blood groups
                    Object.entries(defaultStock).forEach(([group, data]) => {
                        if (!this.bloodStock[group]) {
                            this.bloodStock[group] = { ...data };
                        }
                    });
                },

                // Update local blood stock and calculate statistics
                updateLocalBloodStock(bloodGroup, units) {
                    this.ensureBloodStockInitialized();
                    
                    if (!this.bloodStock[bloodGroup]) {
                        this.bloodStock[bloodGroup] = { units: 0 };
                    }
                    
                    // Calculate new units, ensuring it doesn't go below 0
                    const newUnits = this.bloodStock[bloodGroup].units + units;
                    this.bloodStock[bloodGroup].units = Math.max(0, newUnits);
                    
                    // Update statistics
                    this.calculateBloodStats();
                },

                // Calculate and update blood stock statistics
                calculateBloodStats() {
                    let total = 0;
                    let critical = [];
                    
                    Object.entries(this.bloodStock).forEach(([group, data]) => {
                        const units = data.units || 0;
                        total += units;
                        if (units < 3) {
                            critical.push(group);
                        }
                    });
                    
                    this.totalBloodUnits = total;
                    this.criticalStockCount = critical.length;
                },

                // Update all blood stock at once
                async updateAllBloodStock() {
                    try {
                        this.isUpdating = true;
                        const hospitalId = '<%= user._id %>';
                        
                        // Prepare the blood stock data to send
                        const stockData = {};
                        const validBloodGroups = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];
                        
                        // Ensure all blood groups are included with valid units
                        validBloodGroups.forEach(group => {
                            const units = parseInt(this.bloodStock[group]?.units) || 0;
                            stockData[group] = {
                                units: units >= 0 ? units : 0
                            };
                        });
                        
                        console.log('Sending blood stock update:', stockData);
                        
                        const response = await fetch(`/api/hospitals/${hospitalId}/blood-stock`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(stockData)
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'Failed to update blood stock');
                        }
                        
                        // Update local state with the response
                        if (result.data) {
                            // Ensure the response has the correct structure
                            Object.keys(result.data).forEach(group => {
                                if (validBloodGroups.includes(group) && result.data[group] && typeof result.data[group] === 'object') {
                                    this.bloodStock[group] = {
                                        units: parseInt(result.data[group].units) || 0
                                    };
                                }
                            });
                            this.calculateBloodStats();
                        }
                        
                        this.showSuccess('Blood stock updated successfully!');
                        
                    } catch (error) {
                        console.error('Error updating blood stock:', error);
                        this.showError(error.message || 'Failed to update blood stock. Please try again.');
                    } finally {
                        this.isUpdating = false;
                    }
                },
                
                // Update blood stock in both UI and database (for individual updates)
                async updateBloodStock() {
                    try {
                        // Ensure newStock is properly initialized
                        if (!this.newStock) {
                            this.newStock = {
                                bloodGroup: '',
                                units: 1,
                                action: 'add',
                                notes: ''
                            };
                        }
                        
                        const { bloodGroup, units, action } = this.newStock;
                        
                        // Validate input
                        if (!bloodGroup) {
                            this.showError('Please select a blood group');
                            return false;
                        }
                        
                        if (!units || isNaN(units) || units <= 0) {
                            this.showError('Please enter a valid number of units (greater than 0)');
                            return false;
                        }
                        
                        // Calculate the actual units to add/remove
                        const actualUnits = action === 'add' ? parseInt(units) : -parseInt(units);
                        
                        // Get hospital ID from EJS template
                        const hospitalId = '<%= user._id %>';
                        
                        try {
                            this.isLoading = true;
                            
                            // Make API call to update stock in database
                            const response = await fetch(`/api/stock/update/${hospitalId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    bloodGroup,
                                    units: actualUnits,
                                    action: action
                                })
                            });
                            
                            const responseData = await response.json();
                            
                            if (!response.ok) {
                                throw new Error(responseData.error || 'Failed to update blood stock in database');
                            }
                            
                            // Update local state with the response from database
                            this.bloodStock = responseData;
                            
                            // Ensure the blood group exists in local state
                            if (!this.bloodStock[bloodGroup]) {
                                this.bloodStock[bloodGroup] = { units: 0 };
                            }
                            
                            // Update the specific blood group units
                            this.bloodStock[bloodGroup].units = responseData[bloodGroup]?.units || 0;
                            this.calculateBloodStats();
                            
                            // Show success message
                            this.showSuccess(`Blood stock ${action === 'add' ? 'increased' : 'decreased'} successfully`);
                            
                            // Reset the form
                            this.newStock = {
                                bloodGroup: '',
                                units: 1,
                                action: 'add',
                                notes: ''
                            };
                            
                            // Close the modal
                            this.showUpdateStockModal = false;
                            
                            return true;
                            
                        } catch (error) {
                            console.error('API Error:', error);
                            // Fallback to local update if API fails
                            this.updateLocalBloodStock(bloodGroup, actualUnits);
                            this.showSuccess(`Updated local blood stock (${action === 'add' ? '+' : ''}${actualUnits} units of ${bloodGroup}). Note: Changes might not be saved to the database.`);
                            
                            // Reset the form
                            this.newStock = {
                                bloodGroup: '',
                                units: 1,
                                action: 'add',
                                notes: ''
                            };
                            
                            // Close the modal
                            this.showUpdateStockModal = false;
                            return false;
                        } finally {
                            this.isLoading = false;
                        }
                    } catch (error) {
                        console.error('Error updating blood stock:', error);
                        this.showError('Failed to update blood stock. ' + (error.message || ''));
                        return false;
                    }
                },

                showSuccess(message) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: message,
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                },

                showError(message) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: message,
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                },

                logout() {
                    // Implement logout functionality
                    window.location.href = '/logout';
                },
                
                // Search functionality
                states: [
                    'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
                    'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka',
                    'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram',
                    'Nagaland', 'Odisha', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu',
                    'Telangana', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal',
                    'Andaman and Nicobar Islands', 'Chandigarh', 'Delhi', 'Jammu and Kashmir',
                    'Ladakh', 'Lakshadweep', 'Puducherry'
                ],
                cities: [],
                filteredCities: [],
                searchFilters: {
                    state: '',
                    city: '',
                    bloodGroup: ''
                },
                searchResults: [],
                searchPerformed: false,
                showRequestModal: false,
                selectedHospital: null,
                requestUnits: 1,
                requestMessage: '',
                isSubmitting: false,

                async fetchCities() {
                    if (!this.searchFilters.state) {
                        this.filteredCities = [];
                        this.searchFilters.city = '';
                        return;
                    }
                    
                    // Simulate API call to fetch cities for the selected state
                    // In a real app, you would make an API call here
                    try {
                        // This is a mock implementation
                        // Replace with actual API call to get cities for the selected state
                        const mockCities = {"Andhra Pradesh": ["Anantapur", "Chittoor", "East Godavari", "Guntur", "Krishna", "Kurnool", "Prakasam", "Srikakulam", "Visakhapatnam", "Vizianagaram", "West Godavari", "YSR Kadapa"],
    "Bihar": ["Araria", "Arwal", "Aurangabad", "Banka", "Begusarai", "Bhagalpur", "Bhojpur", "Buxar", "Darbhanga", "East Champaran", "Gaya", "Gopalganj", "Jamui", "Jehanabad", "Kaimur", "Katihar", "Khagaria", "Kishanganj", "Lakhisarai", "Madhepura", "Madhubani", "Munger", "Muzaffarpur", "Nalanda", "Nawada", "Patna", "Purnia", "Rohtas", "Saharsa", "Samastipur", "Saran", "Sheikhpura", "Sheohar", "Sitamarhi", "Siwan", "Supaul", "Vaishali", "West Champaran"],
    'Andhra Pradesh': ['Anantapur', 'Chittoor', 'East Godavari', 'Guntur', 'Krishna', 'Kurnool', 'Nellore', 'Prakasam', 'Srikakulam', 'Visakhapatnam', 'Vizianagaram', 'West Godavari', 'YSR Kadapa'],
            'Arunachal Pradesh': ['Anjaw', 'Changlang', 'Dibang Valley', 'East Kameng', 'East Siang', 'Kamle', 'Kra Daadi', 'Kurung Kumey', 'Lepa Rada', 'Lohit', 'Longding', 'Lower Dibang Valley', 'Lower Siang', 'Lower Subansiri', 'Namsai', 'Pakke Kessang', 'Papum Pare', 'Shi Yomi', 'Siang', 'Tawang', 'Tirap', 'Upper Siang', 'Upper Subansiri', 'West Kameng', 'West Siang'],
            'Assam': ['Baksa', 'Barpeta', 'Biswanath', 'Bongaigaon', 'Cachar', 'Charaideo', 'Chirang', 'Darrang', 'Dhemaji', 'Dhubri', 'Dibrugarh', 'Dima Hasao', 'Goalpara', 'Golaghat', 'Hailakandi', 'Hojai', 'Jorhat', 'Kamrup', 'Kamrup Metropolitan', 'Karbi Anglong', 'Karimganj', 'Kokrajhar', 'Lakhimpur', 'Majuli', 'Morigaon', 'Nagaon', 'Nalbari', 'Sivasagar', 'Sonitpur', 'South Salmara-Mankachar', 'Tinsukia', 'Udalguri', 'West Karbi Anglong'],
            'Bihar': ['Araria', 'Arwal', 'Aurangabad', 'Banka', 'Begusarai', 'Bhagalpur', 'Bhojpur', 'Buxar', 'Darbhanga', 'East Champaran', 'Gaya', 'Gopalganj', 'Jamui', 'Jehanabad', 'Kaimur', 'Katihar', 'Khagaria', 'Kishanganj', 'Lakhisarai', 'Madhepura', 'Madhubani', 'Munger', 'Muzaffarpur', 'Nalanda', 'Nawada', 'Patna', 'Purnia', 'Rohtas', 'Saharsa', 'Samastipur', 'Saran', 'Sheikhpura', 'Sheohar', 'Sitamarhi', 'Siwan', 'Supaul', 'Vaishali', 'West Champaran'],
            'Chhattisgarh': ['Balod', 'Baloda Bazar', 'Balrampur', 'Bastar', 'Bemetara', 'Bijapur', 'Bilaspur', 'Dantewada', 'Dhamtari', 'Durg', 'Gariaband', 'Janjgir-Champa', 'Jashpur', 'Kabirdham', 'Kanker', 'Kondagaon', 'Korba', 'Koriya', 'Mahasamund', 'Mungeli', 'Narayanpur', 'Raigarh', 'Raipur', 'Rajnandgaon', 'Sukma', 'Surajpur', 'Surguja'],
            'Goa': ['North Goa', 'South Goa'],
            'Gujarat': ['Ahmedabad', 'Amreli', 'Anand', 'Aravalli', 'Banaskantha', 'Bharuch', 'Bhavnagar', 'Botad', 'Chhota Udaipur', 'Dahod', 'Dang', 'Devbhoomi Dwarka', 'Gandhinagar', 'Gir Somnath', 'Jamnagar', 'Junagadh', 'Kheda', 'Kutch', 'Mahisagar', 'Mehsana', 'Morbi', 'Narmada', 'Navsari', 'Panchmahal', 'Patan', 'Porbandar', 'Rajkot', 'Sabarkantha', 'Surat', 'Surendranagar', 'Tapi', 'Vadodara', 'Valsad'],
            'Haryana': ['Ambala', 'Bhiwani', 'Charkhi Dadri', 'Faridabad', 'Fatehabad', 'Gurugram', 'Hisar', 'Jhajjar', 'Jind', 'Kaithal', 'Karnal', 'Kurukshetra', 'Mahendragarh', 'Nuh', 'Palwal', 'Panchkula', 'Panipat', 'Rewari', 'Rohtak', 'Sirsa', 'Sonipat', 'Yamunanagar'],
            'Himachal Pradesh': ['Bilaspur', 'Chamba', 'Hamirpur', 'Kangra', 'Kinnaur', 'Kullu', 'Lahaul and Spiti', 'Mandi', 'Shimla', 'Sirmaur', 'Solan', 'Una'],
            'Jharkhand': ['Bokaro', 'Chatra', 'Deoghar', 'Dhanbad', 'Dumka', 'East Singhbhum', 'Garhwa', 'Giridih', 'Godda', 'Gumla', 'Hazaribagh', 'Jamtara', 'Khunti', 'Koderma', 'Latehar', 'Lohardaga', 'Pakur', 'Palamu', 'Ramgarh', 'Ranchi', 'Sahibganj', 'Seraikela Kharsawan', 'Simdega', 'West Singhbhum'],
            'Karnataka': ['Bagalkot', 'Ballari', 'Belagavi', 'Bengaluru Rural', 'Bengaluru Urban', 'Bidar', 'Chamarajanagar', 'Chikballapur', 'Chikkamagaluru', 'Chitradurga', 'Dakshina Kannada', 'Davanagere', 'Dharwad', 'Gadag', 'Hassan', 'Haveri', 'Kalaburagi', 'Kodagu', 'Kolar', 'Koppal', 'Mandya', 'Mysuru', 'Raichur', 'Ramanagara', 'Shivamogga', 'Tumakuru', 'Udupi', 'Uttara Kannada', 'Vijayapura', 'Yadgir'],
            'Kerala': ['Alappuzha', 'Ernakulam', 'Idukki', 'Kannur', 'Kasaragod', 'Kollam', 'Kottayam', 'Kozhikode', 'Malappuram', 'Palakkad', 'Pathanamthitta', 'Thiruvananthapuram', 'Thrissur', 'Wayanad'],
            'Madhya Pradesh': ['Agar Malwa', 'Alirajpur', 'Anuppur', 'Ashoknagar', 'Balaghat', 'Barwani', 'Betul', 'Bhind', 'Bhopal', 'Burhanpur', 'Chhatarpur', 'Chhindwara', 'Damoh', 'Datia', 'Dewas', 'Dhar', 'Dindori', 'Guna', 'Gwalior', 'Harda', 'Hoshangabad', 'Indore', 'Jabalpur', 'Jhabua', 'Katni', 'Khandwa', 'Khargone', 'Mandla', 'Mandsaur', 'Morena', 'Narsinghpur', 'Neemuch', 'Panna', 'Raisen', 'Rajgarh', 'Ratlam', 'Rewa', 'Sagar', 'Satna', 'Sehore', 'Seoni', 'Shahdol', 'Shajapur', 'Sheopur', 'Shivpuri', 'Sidhi', 'Singrauli', 'Tikamgarh', 'Ujjain', 'Umaria', 'Vidisha'],
            'Maharashtra': ['Ahmednagar', 'Akola', 'Amravati', 'Aurangabad', 'Beed', 'Bhandara', 'Buldhana', 'Chandrapur', 'Dhule', 'Gadchiroli', 'Gondia', 'Hingoli', 'Jalgaon', 'Jalna', 'Kolhapur', 'Latur', 'Mumbai City', 'Mumbai Suburban', 'Nagpur', 'Nanded', 'Nandurbar', 'Nashik', 'Osmanabad', 'Palghar', 'Parbhani', 'Pune', 'Raigad', 'Ratnagiri', 'Sangli', 'Satara', 'Sindhudurg', 'Solapur', 'Thane', 'Wardha', 'Washim', 'Yavatmal'],
            'Manipur': ['Bishnupur', 'Chandel', 'Churachandpur', 'Imphal East', 'Imphal West', 'Jiribam', 'Kakching', 'Kamjong', 'Kangpokpi', 'Noney', 'Pherzawl', 'Senapati', 'Tamenglong', 'Tengnoupal', 'Thoubal', 'Ukhrul'],
            'Meghalaya': ['East Garo Hills', 'East Jaintia Hills', 'East Khasi Hills', 'North Garo Hills', 'Ri Bhoi', 'South Garo Hills', 'South West Garo Hills', 'South West Khasi Hills', 'West Garo Hills', 'West Jaintia Hills', 'West Khasi Hills'],
            'Mizoram': ['Aizawl', 'Champhai', 'Hnahthial', 'Khawzawl', 'Kolasib', 'Lawngtlai', 'Lunglei', 'Mamit', 'Saiha', 'Saitual', 'Serchhip'],
            'Nagaland': ['Dimapur', 'Kiphire', 'Kohima', 'Longleng', 'Mokokchung', 'Mon', 'Peren', 'Phek', 'Tuensang', 'Wokha', 'Zunheboto'],
            'Odisha': ['Angul', 'Balangir', 'Balasore', 'Bargarh', 'Bhadrak', 'Boudh', 'Cuttack', 'Deogarh', 'Dhenkanal', 'Gajapati', 'Ganjam', 'Jagatsinghpur', 'Jajpur', 'Jharsuguda', 'Kalahandi', 'Kandhamal', 'Kendrapara', 'Kendujhar', 'Khordha', 'Koraput', 'Malkangiri', 'Mayurbhanj', 'Nabarangpur', 'Nayagarh', 'Nuapada', 'Puri', 'Rayagada', 'Sambalpur', 'Subarnapur', 'Sundargarh'],
            'Punjab': ['Amritsar', 'Barnala', 'Bathinda', 'Faridkot', 'Fatehgarh Sahib', 'Fazilka', 'Ferozepur', 'Gurdaspur', 'Hoshiarpur', 'Jalandhar', 'Kapurthala', 'Ludhiana', 'Mansa', 'Moga', 'Muktsar', 'Pathankot', 'Patiala', 'Rupnagar', 'Sahibzada Ajit Singh Nagar', 'Sangrur', 'Shahid Bhagat Singh Nagar', 'Tarn Taran'],
            'Rajasthan': ['Ajmer', 'Alwar', 'Banswara', 'Baran', 'Barmer', 'Bharatpur', 'Bhilwara', 'Bikaner', 'Bundi', 'Chittorgarh', 'Churu', 'Dausa', 'Dholpur', 'Dungarpur', 'Hanumangarh', 'Jaipur', 'Jaisalmer', 'Jalore', 'Jhalawar', 'Jhunjhunu', 'Jodhpur', 'Karauli', 'Kota', 'Nagaur', 'Pali', 'Pratapgarh', 'Rajsamand', 'Sawai Madhopur', 'Sikar', 'Sirohi', 'Sri Ganganagar', 'Tonk', 'Udaipur'],
            'Sikkim': ['East Sikkim', 'North Sikkim', 'South Sikkim', 'West Sikkim'],
            'Tamil Nadu': ['Ariyalur', 'Chengalpattu', 'Chennai', 'Coimbatore', 'Cuddalore', 'Dharmapuri', 'Dindigul', 'Erode', 'Kallakurichi', 'Kancheepuram', 'Karur', 'Krishnagiri', 'Madurai', 'Mayiladuthurai', 'Nagapattinam', 'Namakkal', 'Perambalur', 'Pudukkottai', 'Ramanathapuram', 'Ranipet', 'Salem', 'Sivaganga', 'Tenkasi', 'Thanjavur', 'Theni', 'Thoothukudi', 'Tiruchirappalli', 'Tirunelveli', 'Tirupathur', 'Tiruppur', 'Tiruvallur', 'Tiruvannamalai', 'Tiruvarur', 'Vellore', 'Viluppuram', 'Virudhunagar'],
            'Telangana': ['Adilabad', 'Bhadradri Kothagudem', 'Hyderabad', 'Jagtial', 'Jangaon', 'Jayashankar Bhupalpally', 'Jogulamba Gadwal', 'Kamareddy', 'Karimnagar', 'Khammam', 'Komaram Bheem Asifabad', 'Mahabubabad', 'Mahabubnagar', 'Mancherial', 'Medak', 'Medchal-Malkajgiri', 'Mulugu', 'Nagarkurnool', 'Nalgonda', 'Narayanpet', 'Nirmal', 'Nizamabad', 'Peddapalli', 'Rajanna Sircilla', 'Rangareddy', 'Sangareddy', 'Siddipet', 'Suryapet', 'Vikarabad', 'Wanaparthy', 'Warangal Rural', 'Warangal Urban', 'Yadadri Bhuvanagiri'],
            'Tripura': ['Dhalai', 'Gomati', 'Khowai', 'North Tripura', 'Sepahijala', 'South Tripura', 'Unakoti', 'West Tripura'],
            'Uttar Pradesh': ['Agra', 'Aligarh', 'Ambedkar Nagar', 'Amethi', 'Amroha', 'Auraiya', 'Ayodhya', 'Azamgarh', 'Baghpat', 'Bahraich', 'Ballia', 'Balrampur', 'Banda', 'Barabanki', 'Bareilly', 'Basti', 'Bhadohi', 'Bijnor', 'Budaun', 'Bulandshahr', 'Chandauli', 'Chitrakoot', 'Deoria', 'Etah', 'Etawah', 'Farrukhabad', 'Fatehpur', 'Firozabad', 'Gautam Buddha Nagar', 'Ghaziabad', 'Ghazipur', 'Gonda', 'Gorakhpur', 'Hamirpur', 'Hapur', 'Hardoi', 'Hathras', 'Jalaun', 'Jaunpur', 'Jhansi', 'Kannauj', 'Kanpur Dehat', 'Kanpur Nagar', 'Kasganj', 'Kaushambi', 'Kheri', 'Kushinagar', 'Lalitpur', 'Lucknow', 'Maharajganj', 'Mahoba', 'Mainpuri', 'Mathura', 'Mau', 'Meerut', 'Mirzapur', 'Moradabad', 'Muzaffarnagar', 'Pilibhit', 'Pratapgarh', 'Prayagraj', 'Raebareli', 'Rampur', 'Saharanpur', 'Sambhal', 'Sant Kabir Nagar', 'Shahjahanpur', 'Shamli', 'Shravasti', 'Siddharthnagar', 'Sitapur', 'Sonbhadra', 'Sultanpur', 'Unnao', 'Varanasi'],
            'Uttarakhand': ['Almora', 'Bageshwar', 'Chamoli', 'Champawat', 'Dehradun', 'Haridwar', 'Nainital', 'Pauri Garhwal', 'Pithoragarh', 'Rudraprayag', 'Tehri Garhwal', 'Udham Singh Nagar', 'Uttarkashi'],
            'West Bengal': ['Alipurduar', 'Bankura', 'Birbhum', 'Cooch Behar', 'Dakshin Dinajpur', 'Darjeeling', 'Hooghly', 'Howrah', 'Jalpaiguri', 'Jhargram', 'Kalimpong', 'Kolkata', 'Malda', 'Murshidabad', 'Nadia', 'North 24 Parganas', 'Paschim Bardhaman', 'Paschim Medinipur', 'Purba Bardhaman', 'Purba Medinipur', 'Purulia', 'South 24 Parganas', 'Uttar Dinajpur'],
            'Andaman and Nicobar Islands': ['Nicobar', 'North and Middle Andaman', 'South Andaman'],
            'Chandigarh': ['Chandigarh'],
            'Dadra and Nagar Haveli and Daman and Diu': ['Dadra and Nagar Haveli', 'Daman', 'Diu'],
            'Delhi': ['Central Delhi', 'East Delhi', 'New Delhi', 'North Delhi', 'North East Delhi', 'North West Delhi', 'Shahdara', 'South Delhi', 'South East Delhi', 'South West Delhi', 'West Delhi'],
            'Jammu and Kashmir': ['Anantnag', 'Bandipora', 'Baramulla', 'Budgam', 'Doda', 'Ganderbal', 'Jammu', 'Kathua', 'Kishtwar', 'Kulgam', 'Kupwara', 'Poonch', 'Pulwama', 'Rajouri', 'Ramban', 'Reasi', 'Samba', 'Shopian', 'Srinagar', 'Udhampur'],
            'Ladakh': ['Kargil', 'Leh'],
            'Lakshadweep': ['Lakshadweep'],
            'Puducherry': ['Karaikal', 'Mahe', 'Puducherry', 'Yanam']
                        };
                        
                        this.cities = mockCities[this.searchFilters.state] || [];
                        this.filteredCities = [...this.cities];
                        this.searchFilters.city = '';
                    } catch (error) {
                        console.error('Error fetching cities:', error);
                        this.showError('Failed to load cities');
                    }
                },

                // Leaflet map variables
                map: null,
                markers: [],
                showMap: false,
                
                // Initialize map
                initMap() {
                    if (this.map) return;
                    
                    // Create a new Leaflet map instance
                    this.map = L.map('map').setView([20.5937, 78.9629], 5); // Center of India
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(this.map);
                },
                
                // Add markers to the map
                addMarkers(hospitals) {
                    // Clear existing markers
                    this.clearMarkers();
                    
                    if (!hospitals.length) return;
                    
                    const bounds = [];
                    
                    hospitals.forEach(hospital => {
                        if (!hospital.geometry) return;
                        
                        const position = [
                            hospital.geometry.location.lat(),
                            hospital.geometry.location.lng()
                        ];
                        
                        // Add position to bounds
                        bounds.push(position);
                        
                        // Create a custom icon
                        const icon = L.divIcon({
                            className: 'hospital-marker',
                            html: '<div class="bg-red-600 rounded-full w-8 h-8 flex items-center justify-center text-white"><i class="fas fa-hospital"></i></div>',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32],
                            popupAnchor: [0, -32]
                        });
                        
                        // Create marker with popup
                        const marker = L.marker(position, { icon })
                            .addTo(this.map)
                            .bindPopup(`
                                <h4 class="font-semibold text-gray-900 text-sm mb-2">${hospital.name}</h4>
                                <p class="text-xs text-gray-600 mb-2">
                                    <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>
                                    ${hospital.vicinity || hospital.formatted_address || 'Address not available'}
                                </p>
                                ${hospital.rating ? `
                                    <div class="flex items-center text-xs text-gray-700 mb-2">
                                        <i class="fas fa-star text-yellow-400 mr-1"></i>
                                        <span>${hospital.rating} (${hospital.user_ratings_total || 0} reviews)</span>
                                    </div>
                                ` : ''}
                                <div class="popup-footer">
                                    <a href="https://www.openstreetmap.org/directions?from=&to=${position[0]},${position[1]}" 
                                       target="_blank" 
                                       class="text-xs text-blue-600 hover:text-blue-800 flex items-center">
                                        <i class="fas fa-directions mr-1"></i> Directions
                                    </a>
                                </div>
                            `, {
                                maxWidth: 250,
                                className: 'custom-popup'
                            });
                        
                        this.markers.push(marker);
                    });
                    
                    // Fit the map to the bounds if we have markers
                    if (bounds.length > 0) {
                        this.map.fitBounds(bounds, { padding: [50, 50] });
                    }
                },
                
                // Clear all markers from the map
                clearMarkers() {
                    this.markers.forEach(marker => this.map.removeLayer(marker));
                    this.markers = [];
                },
                
                // Open request modal for a specific hospital
                openRequestModal(hospital) {
                    this.selectedHospital = hospital;
                    this.requestUnits = 1;
                    this.contactPerson = '';
                    this.contactNumber = '';
                    this.requestPriority = 'medium';
                    this.requestNotes = '';
                    this.showRequestModal = true;
                },

                // Submit blood request to another hospital
                async submitRequest() {
                    try {
                        if (!this.selectedHospital || !this.searchFilters.bloodGroup || !this.requestUnits || !this.contactPerson || !this.contactNumber) {
                            this.showError('Please fill in all required fields');
                            return;
                        }

                        // Get the current hospital (source) details from the template
                        const sourceHospitalId = '<%= user._id %>';
                        const sourceHospitalName = '<%= user.hospitalName %>';

                        // Get the target hospital details from the selected hospital
                        const targetHospitalId = this.selectedHospital.place_id;
                        const targetHospitalName = this.selectedHospital.name;

                        // Prepare the request data with both source and target hospital info
                        const requestData = {
                            sourceHospitalId,
                            sourceHospitalName,
                            targetHospitalId,
                            targetHospitalName,
                            bloodGroup: this.searchFilters.bloodGroup,
                            units: this.requestUnits,
                            contactPerson: this.contactPerson,
                            contactNumber: this.contactNumber,
                            priority: this.requestPriority,
                            notes: this.requestNotes
                        };

                        // Show loading state
                        this.isSubmitting = true;

                        // Send the request to the server
                        const response = await fetch('/api/request/hospital-blood', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestData)
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.message || 'Failed to submit blood request');
                        }

                        // Show success message
                        this.showSuccess('Blood request submitted successfully!');
                        
                        // Close the modal
                        this.showRequestModal = false;
                        
                        // Reset form
                        this.requestUnits = 1;
                        this.contactPerson = '';
                        this.contactNumber = '';
                        this.requestPriority = 'medium';
                        this.requestNotes = '';

                    } catch (error) {
                        console.error('Error submitting blood request:', error);
                        this.showError(error.message || 'Failed to submit blood request. Please try again.');
                    } finally {
                        this.isSubmitting = false;
                    }
                },

                // Search for hospitals using OpenStreetMap's Nominatim
                async searchHospitals() {
                    if (!this.searchFilters.bloodGroup) {
                        this.showError('Please select a blood group');
                        return;
                    }
                    
                    if (!this.searchFilters.state && !this.searchFilters.city) {
                        this.showError('Please select at least a state or city');
                        return;
                    }
                    
                    this.isLoading = true;
                    this.searchResults = [];
                    
                    try {
                        // Initialize map if not already done
                        if (this.showMap) {
                            this.initMap();
                        }
                        
                        // Construct the query for Nominatim
                        let query = 'hospital';
                        if (this.searchFilters.city) {
                            query += ` in ${this.searchFilters.city}`;
                        } else if (this.searchFilters.state) {
                            query += ` in ${this.searchFilters.state}`;
                        }
                        query += ' India';
                        
                        // Use Nominatim to search for hospitals
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=10`);
                        
                        if (!response.ok) {
                            throw new Error('Failed to fetch hospitals');
                        }
                        
                        const results = await response.json();
                        
                        // Process the results to match our expected format
                        this.searchResults = results.map(place => ({
                            name: place.display_name.split(',')[0] || 'Hospital',
                            formatted_address: place.display_name,
                            geometry: {
                                location: {
                                    lat: () => parseFloat(place.lat),
                                    lng: () => parseFloat(place.lon)
                                }
                            },
                            place_id: place.place_id,
                            vicinity: place.display_name,
                            rating: null,
                            user_ratings_total: null,
                            formatted_phone_number: null,
                            website: `https://www.openstreetmap.org/${place.osm_type}/${place.osm_id}`
                        }));
                        
                        this.searchPerformed = true;
                        
                        // Update the map if in map view
                        if (this.showMap && this.searchResults.length > 0) {
                            this.addMarkers(this.searchResults);
                        }
                        
                    } catch (error) {
                        console.error('Error searching for hospitals:', error);
                        this.showError('Failed to search for hospitals. Please try again later or try a different location.');
                    } finally {
                        this.isLoading = false;
                    }
                },

                openRequestModal(hospital) {
                    // Since we don't have blood stock information from Google Places API,
                    // we'll just proceed with the request modal
                    this.selectedHospital = hospital;
                    this.requestUnits = 1;
                    this.requestMessage = '';
                    this.showRequestModal = true;
                },

                async submitBloodRequest() {
                    try {
                        if (!this.selectedHospital || !this.searchFilters.bloodGroup || !this.requestUnits) {
                            this.showError('Please fill in all required fields');
                            return;
                        }

                        // Get the current hospital details from the template
                        const hospitalId = '<%= user._id %>';
                        const hospitalName = '<%= user.hospitalName %>';

                        // Prepare the request data
                        const requestData = {
                            hospitalId,
                            hospitalName,
                            bloodGroup: this.searchFilters.bloodGroup,
                            units: this.requestUnits,
                            contactPerson: this.contactPerson || '',
                            contactNumber: this.contactNumber || '',
                            priority: this.requestPriority || 'medium',
                            notes: this.requestNotes || ''
                        };

                        // Show loading state
                        this.isLoading = true;

                        // Send the request to the server
                        const response = await fetch('/api/request/hospital-blood', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestData)
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.message || 'Failed to submit blood request');
                        }

                        // Show success message
                        this.showSuccess('Blood request submitted successfully!');
                        
                        // Close the modal
                        this.showRequestModal = false;
                        
                        // Reset form
                        this.requestUnits = '';
                        this.contactPerson = '';
                        this.contactNumber = '';
                        this.requestPriority = 'medium';
                        this.requestNotes = '';
                        
                        // Optionally refresh the requests list
                        this.fetchBloodRequests();

                    } catch (error) {
                        console.error('Error submitting blood request:', error);
                        this.showError(error.message || 'Failed to submit blood request. Please try again.');
                    } finally {
                        this.isLoading = false;
                    }
                    
                    if (this.requestUnits < 1) {
                        this.showError('Please enter a valid number of units');
                        return;
                    }
                    
                    // Removed stock check since we don't have this information from Google Places API
                    
                    this.isSubmitting = true;
                    
                    try {
                        // Simulate API call to submit blood request
                        // In a real app, you would make an API call here
                        // const response = await fetch('/api/blood-requests', {
                        //     method: 'POST',
                        //     headers: {
                        //         'Content-Type': 'application/json',
                        //     },
                        //     body: JSON.stringify({
                        //         hospitalId: this.selectedHospital._id,
                        //         bloodGroup: this.searchFilters.bloodGroup,
                        //         units: this.requestUnits,
                        //         message: this.requestMessage,
                        //         status: 'pending'
                        //     })
                        // });
                        // 
                        // if (!response.ok) {
                        //     throw new Error('Failed to submit request');
                        // }
                        
                        // Show success message
                        this.showSuccess('Blood request submitted successfully');
                        
                        // Close the modal and reset form
                        this.showRequestModal = false;
                        this.requestMessage = '';
                        this.requestUnits = 1;
                        
                    } catch (error) {
                        console.error('Error submitting blood request:', error);
                        this.showError('Failed to submit blood request');
                    } finally {
                        this.isSubmitting = false;
                    }
                },

                // Getter for the current user ID
                get userId() {
                    return '<%= user._id %>';
                }
            };
        }

        // Blood Requests Component
        document.addEventListener('alpine:init', () => {
            Alpine.data('bloodRequests', () => ({
                // Store current hospital name
                currentHospitalName: '<%= user.hospitalName %>',
                requests: [],
                isLoading: false,
                error: null,

                async fetchRequests() {
                    this.isLoading = true;
                    this.error = null;
                    
                    try {
                        // Fetch requests where target hospital is the current hospital
                        const response = await fetch(`/api/demo-requests?targetHospitalName=${encodeURIComponent(this.currentHospitalName)}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch requests');
                        }
                        
                        const allRequests = await response.json();
                        console.log('Fetched requests:', allRequests);
                        
                        // Filter out any test data or invalid entries
                        this.requests = allRequests.filter(request => 
                            request.targetHospitalName && 
                            request.sourceHospitalName &&
                            request.bloodGroup &&
                            request.units > 0
                        );
                        
                        console.log('Filtered requests:', this.requests);
                        
                    } catch (err) {
                        console.error('Error fetching blood requests:', err);
                        this.error = 'Failed to load requests. Please try again.';
                    } finally {
                        this.isLoading = false;
                    }
                },

                // Check if a hospital name is valid (not test data)
                isValidHospitalName(name) {
                    if (!name) return false;
                    const lowerName = name.toLowerCase();
                    return !['test', 'demo', 'example', 'txtxx'].some(term => lowerName.includes(term));
                },

                // Initialize component
                init() {
                    this.fetchRequests();
                }
            }));
        });
    </script>
</body>
</html>
