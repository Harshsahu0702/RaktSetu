<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - RaktSetu</title>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }

        /* Custom dropdown styling */
        .custom-select {
            position: relative;
            width: 100%;
        }

        .custom-select select {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: white;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.5em 1.5em;
            cursor: pointer;
        }

        .custom-select select:focus {
            outline: none;
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        /* Make sure dropdown options are scrollable */
        select option {
            padding: 0.5rem;
            background-color: white;
            color: #1f2937;
        }

        /* For Firefox */
        select {
            -moz-appearance: none !important;
            text-indent: 1px;
            text-overflow: '';
        }

        /* For IE10+ */
        select::-ms-expand {
            display: none;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .nav-link {
            position: relative;
            transition: color 0.3s ease;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 0;
            background-color: #ef4444;
            transition: width 0.3s ease;
        }

        .nav-link:hover::after,
        .nav-link.active::after {
            width: 100%;
        }

        .nav-link.active {
            color: #ef4444;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.3);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-input {
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .search-input:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .donor-card {
            transition: all 0.3s ease;
        }

        .donor-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
    <!-- Add Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- SweetAlert2 for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="min-h-screen" data-patient-id="<%= user._id %>">
    <!-- Request Blood Modal -->
    <div id="requestModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 w-full max-w-md">
            <div class="bg-white rounded-lg shadow-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Blood Request</h3>
                    <button onclick="closeRequestModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hospital</label>
                        <input type="text" id="hospitalName" class="w-full p-2 border rounded-md" readonly>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Blood Type</label>
                            <input type="text" id="requestBloodType" class="w-full p-2 border rounded-md" readonly>
                        </div>
                        <div>
                            <label for="units" class="block text-sm font-medium text-gray-700 mb-1">Units
                                Required</label>
                            <input type="number" id="units" min="1" max="10" value="1"
                                class="w-full p-2 border rounded-md">
                        </div>
                    </div>

                    <div>
                        <label for="urgency" class="block text-sm font-medium text-gray-700 mb-1">Urgency Level</label>
                        <select id="urgency" class="w-full p-2 border rounded-md">
                            <option value="normal">Normal (Within 24 hours)</option>
                            <option value="urgent">Urgent (Within 6 hours)</option>
                            <option value="emergency">Emergency (Within 1 hour)</option>
                        </select>
                    </div>

                    <div>
                        <label for="requiredBy" class="block text-sm font-medium text-gray-700 mb-1">Required By</label>
                        <input type="datetime-local" id="requiredBy" class="w-full p-2 border rounded-md">
                    </div>

                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                        <textarea id="notes" rows="3" class="w-full p-2 border rounded-md"
                            placeholder="Any special requirements or notes..."></textarea>
                    </div>
                </div>

                <div class="mt-6 flex space-x-3">
                    <button onclick="submitBloodRequest()"
                        class="flex-1 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        Submit Request
                    </button>
                    <button onclick="closeRequestModal()"
                        class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-tint text-red-600 text-2xl mr-2"></i>
                        <span class="text-xl font-bold text-gray-800">RaktConnect</span>
                    </div>
                    <div class="hidden md:ml-10 md:flex md:space-x-8">
                        <a href="/patient"
                            class="border-b-2 border-red-500 text-gray-900 inline-flex items-center px-1 pt-1 text-sm font-medium">Dashboard</a>
                        <a href="/requests?patientId=<%= user._id %>"
                            class="text-gray-500 hover:text-gray-700 hover:border-b-2 hover:border-gray-300 inline-flex items-center px-1 pt-1 text-sm font-medium">Requests</a>
                    </div>
                </div>
                <div class="hidden md:ml-4 md:flex-shrink-0 md:flex md:items-center">
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="flex items-center max-w-xs rounded-full focus:outline-none"
                            id="user-menu" aria-expanded="false" aria-haspopup="true">
                            <img class="h-8 w-8 rounded-full"
                                src="https://ui-avatars.com/api/?name=<%= user.fullName %>&background=ef4444&color=fff"
                                alt="User profile">
                            <span class="ml-2 text-sm font-medium text-gray-700">
                                <%= user.fullName %>
                            </span>
                            <i class="fas fa-chevron-down ml-1 text-gray-500 text-xs"></i>
                        </button>
                        <div x-show="open" @click.away="open = false"
                            class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5"
                            role="menu" aria-orientation="vertical" aria-labelledby="user-menu">
                            <div class="py-1" role="none">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                                <a href="#" onclick="deleteAccount('<%= user._id %>')"
                                    class="block px-4 py-2 text-sm text-red-700 hover:bg-gray-100">Delete Account</a>
                                <a href="/get-started"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="-mr-2 flex items-center md:hidden">
                    <button type="button"
                        class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none"
                        aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <i class="fas fa-bars h-6 w-6"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile menu -->
    <div class="md:hidden hidden" id="mobile-menu">
        <div class="pt-2 pb-3 space-y-1">
            <a href="/requests?patientId=<%= user._id %>" class="bg-red-50 border-red-500 text-red-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Dashboard</a>
            <a href="/requests?patientId=<%= user._id %>"
                class="border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Requests</a>
            <a href="#"
                class="border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Haemoglobin</a>
            <a href="#"
                class="border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Disease</a>
        </div>
        <div class="pt-4 pb-3 border-t border-gray-200">
            <div class="flex items-center px-4">
                <div class="flex-shrink-0">
                    <img class="h-10 w-10 rounded-full"
                        src="https://ui-avatars.com/api/?name=<%= user.fullName %>&background=ef4444&color=fff"
                        alt="User profile">
                </div>
                <div class="ml-3">
                    <div class="text-base font-medium text-gray-800">
                        <%= user.fullName %>
                    </div>
                    <div class="text-sm font-medium text-gray-500">Patient</div>
                </div>
            </div>
            <div class="mt-3 space-y-1">
                <a href="#"
                    class="block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100">Your
                    Profile</a>
                <a href="#"
                    class="block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100">Settings</a>
                <a href="#"
                    class="block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100">Sign
                    out</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Welcome Banner -->
        <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-xl p-6 text-white mb-8 animate-fade-in">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-1">Welcome back, <%= user.fullName %>
                    </h2>
                    <p class="text-red-100">Check the status of your blood requests and find donors easily.</p>
                </div>
                <div class="flex items-center space-x-4 mt-4 md:mt-0">
                    <a href="/requests?patientId=<%= user._id %>" class="bg-white text-red-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-red-500">
                        View Requests
                    </a>
                    <button id="sosBtn"
                        class="bg-red-700 text-white px-6 py-2 rounded-lg font-medium hover:bg-red-800 transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-red-600 animate-pulse">
                        <i class="fas fa-bell"></i> SOS Request
                    </button>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="glass-card rounded-xl p-6 mb-8 animate-slide-up" style="animation-delay: 0.1s;">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-hospital text-red-500 mr-3"></i>
                Find Blood Availability
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                    <div class="custom-select">
                        <select id="state"
                            class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                            size="1">
                            <option value="">Select State</option>
                            <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chandigarh">Chandigarh</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman
                                and Diu</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Ladakh">Ladakh</option>
                            <option value="Lakshadweep">Lakshadweep</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Puducherry">Puducherry</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>

                        </select>
                    </div>
                </div>
                <div>
                    <label for="district" class="block text-sm font-medium text-gray-700 mb-1">District</label>
                    <div class="custom-select">
                        <select id="district"
                            class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                            size="1">
                            <option value="">Select District</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
                <div>
                    <label for="blood-type" class="block text-sm font-medium text-gray-700 mb-1">Blood Type</label>
                    <div class="custom-select">
                        <select id="blood-type"
                            class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                            size="1">
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-end">
                    <button id="searchHospitalsBtn" type="button"
                        class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <i class="fas fa-search mr-2"></i> Search Hospitals
                    </button>
                </div>
            </div>

            <!-- Search Results -->
            <div id="search-results" class="mt-8">
                <!-- Loading Spinner -->
                <div id="loading-spinner" class="hidden">
                    <div class="flex justify-center items-center mb-4">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"></div>
                    </div>
                    <p class="text-center text-gray-600">Searching for blood availability...</p>
                </div>

                <!-- Results Status -->
                <div id="search-status" class="text-center py-8">
                    <div class="text-gray-400 mb-2">
                        <i class="fas fa-search text-4xl"></i>
                    </div>
                    <h4 class="text-lg font-medium text-gray-600">Search for blood availability</h4>
                    <p class="text-sm text-gray-500">Select state, district and blood type to find available units</p>
                </div>

                <!-- Hospital Cards -->
                <div id="hospitals-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6 mb-6">
                    <!-- Cards will be populated dynamically -->
                </div>

                <!-- Map Container -->
                <div id="map" class="h-[500px] w-full rounded-xl shadow-lg"></div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 mb-8">
            <!-- Approved Requests -->
            <div class="glass-card rounded-xl p-6 animate-slide-up" style="animation-delay: 0.3s;">
                <div class="flex items-center">
                    <div class="p-3 rounded-lg bg-green-100 text-green-600 mr-4">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Approved Requests</p>
                        <h3 class="text-2xl font-bold text-gray-800">5</h3>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm text-green-600">
                    <i class="fas fa-arrow-up mr-1"></i>
                    <span>1 new today</span>
                </div>
            </div>

            <!-- Total Requests -->
            <div class="glass-card rounded-xl p-6 animate-slide-up" style="animation-delay: 0.4s;">
                <div class="flex items-center">
                    <div class="p-3 rounded-lg bg-blue-100 text-blue-600 mr-4">
                        <i class="fas fa-history text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Requests</p>
                        <h3 class="text-2xl font-bold text-gray-800">12</h3>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="/requests?patientId=<%= user._id %>" class="text-sm text-blue-600 hover:underline">View history</a>
                </div>
            </div>
        </div>

        <!-- Donors Results -->
        <div id="donors-results" class="mt-6 space-y-4">
            <!-- Donors will be loaded here -->
        </div>
        </div>
        <div class="grid grid-cols-1 gap-6">
            <!-- Recent Blood Requests -->


                <!-- Nearby Donors (dynamic) -->
            <div class="glass-card rounded-xl p-6 animate-slide-up" style="animation-delay: 0.4s;">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Nearby Donors</h3>
                    <button id="viewAllDonorsBtn" class="text-sm text-red-600 hover:text-red-700 focus:outline-none">View All</button>
                </div>
                <div id="nearby-donors-list" class="space-y-4">
                    <!-- filled dynamically -->
                </div>
                <div class="mt-4 text-center">
                    <button id="loadMoreDonors" class="text-sm text-red-600 hover:text-red-700 font-medium focus:outline-none">
                        Load More <i class="fas fa-chevron-down ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Include external JavaScript -->
    <script src="/script.js"></script>
    <script>
        const patientId = '<%= user._id %>';

        const statusStyles = {
            pending: 'bg-yellow-100 text-yellow-800',
            approved: 'bg-green-100 text-green-800',
            rejected: 'bg-red-100 text-red-800',
            delivering: 'bg-blue-100 text-blue-800',
            completed: 'bg-gray-100 text-gray-800'
        };

        async function fetchPatientRequests() {
            try {
                const response = await fetch(`/api/requests/patient/${patientId}`);
                const requests = await response.json();
                const tableBody = document.getElementById('patient-requests-table-body');
                tableBody.innerHTML = '';

                if (requests.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">You have not made any requests yet.</td></tr>';
                    return;
                }

                requests.forEach(request => {
                    const statusClass = statusStyles[request.status] || 'bg-gray-100 text-gray-800';
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium">${request.bloodGroup}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(request.createdAt).toLocaleDateString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                ${request.status === 'delivering' ? 'Your blood is on the way!' : 'Status updated.'}
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching patient requests:', error);
            }
        }

        async function deleteAccount(patientId) {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/patient/${patientId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        alert('Account deleted successfully.');
                        window.location.href = '/get-started';
                    } else {
                        alert('Failed to delete account.');
                    }
                } catch (error) {
                    console.error('Error deleting account:', error);
                    alert('An error occurred.');
                }
            }
        }

        window.onload = fetchPatientRequests;
    </script>
    <script>
        // Fetch donors from server for a given state and render them
        async function fetchDonorsByState(state) {
            if (!state) return;
            const list = document.getElementById('nearby-donors-list');
            if (!list) return;
            list.innerHTML = '<div class="text-center text-gray-500 py-6">Loading donors...</div>';

            try {
                const res = await fetch(`/api/donors/state/${encodeURIComponent(state)}`);
                if (!res.ok) {
                    throw new Error('Failed to fetch donors');
                }
                const donors = await res.json();
                renderDonors(donors);
            } catch (err) {
                console.error('Error fetching donors by state:', err);
                list.innerHTML = '<div class="text-center text-red-500 py-6">Could not load donors.</div>';
            }
        }

        function renderDonors(donors) {
            const container = document.getElementById('nearby-donors-list');
            container.innerHTML = '';

            if (!donors || donors.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-6">No donors found in this state.</div>';
                return;
            }

            donors.forEach(d => {
                const card = document.createElement('div');
                card.className = 'donor-card flex items-center p-3 bg-white rounded-lg border border-gray-100 hover:shadow-md transition-all';

                const img = document.createElement('img');
                img.className = 'w-12 h-12 rounded-full object-cover';
                img.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(d.fullName)}&background=ef4444&color=fff`;
                img.alt = d.fullName || 'Donor';

                const info = document.createElement('div');
                info.className = 'ml-3 flex-1';

                const name = document.createElement('h4');
                name.className = 'text-sm font-medium text-gray-800';
                name.textContent = d.fullName || 'Anonymous';

                const meta = document.createElement('div');
                meta.className = 'flex items-center mt-1 text-xs text-gray-500';
                meta.textContent = `${d.bloodGroup || '-'} • ${d.city || '-'}, ${d.state || '-'}`;

                info.appendChild(name);
                info.appendChild(meta);

                const btnWrap = document.createElement('div');

                const requestBtn = document.createElement('button');
                requestBtn.className = 'ml-2 px-3 py-1 bg-red-600 text-white text-xs font-medium rounded-full hover:bg-red-700 transition-colors';
                requestBtn.textContent = 'Request';
                requestBtn.onclick = async (e) => {
                    e.preventDefault();
                    const donorId = d._id || d.id || null;
                    const donorName = d.fullName || '';
                    const bloodGroup = d.bloodGroup || '';
                    if (!donorId) {
                        await Swal.fire('Error', 'Donor id not available', 'error');
                        return;
                    }

                    const confirm = await Swal.fire({
                        title: 'Send Request to Donor?',
                        text: `Request ${bloodGroup || ''} from ${donorName}?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#EF4444',
                        confirmButtonText: 'Send Request'
                    });

                    if (!confirm.isConfirmed) return;

                    try {
                        const payload = {
                            patientId: document.body.dataset.patientId || '<%= user._id %>',
                            donorId,
                            donorName,
                            bloodGroup,
                            units: 1
                        };

                        const resp = await fetch('/api/request/donor', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const data = await resp.json();
                        if (resp.ok && data.success) {
                            await Swal.fire('Request sent', 'Your request was sent to the donor.', 'success');
                        } else {
                            console.error('Request failed', data);
                            await Swal.fire('Error', data.message || 'Could not send request', 'error');
                        }
                    } catch (err) {
                        console.error('Error sending donor request:', err);
                        await Swal.fire('Error', 'Could not send request', 'error');
                    }
                };

                btnWrap.appendChild(requestBtn);

                card.appendChild(img);
                card.appendChild(info);
                card.appendChild(btnWrap);

                container.appendChild(card);
            });
        }

        // On page load, try to fetch donors for the rendered patient (if server provided state)
        document.addEventListener('DOMContentLoaded', function () {
            const patientState = '<%= user && user.state ? user.state : "" %>';
            if (patientState) fetchDonorsByState(patientState);

            // Also fetch donors when patient selects a state from the search dropdown
            const stateSelect = document.getElementById('state');
            if (stateSelect) {
                stateSelect.addEventListener('change', function () {
                    const selected = this.value;
                    if (selected) fetchDonorsByState(selected);
                });
            }
        });
    </script>
    <script>
        const sosBtn = document.getElementById('sosBtn');
        sosBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    const response = await fetch('/api/requests/sos', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            patientId: '<%= user._id %>',
                            bloodGroup: '<%= user.bloodGroup %>',
                            city: '<%= user.city %>',
                            latitude,
                            longitude
                        })
                    });
                    const data = await response.json();
                    alert(data.message);
                    fetchPatientRequests();
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        });

    </script>
    <script>
        // Indian states with their major cities
        // Make stateDistricts globally available
        window.stateDistricts = {
            'Andhra Pradesh': ['Anantapur', 'Chittoor', 'East Godavari', 'Guntur', 'Krishna', 'Kurnool', 'Nellore', 'Prakasam', 'Srikakulam', 'Visakhapatnam', 'Vizianagaram', 'West Godavari', 'YSR Kadapa'],
            'Arunachal Pradesh': ['Anjaw', 'Changlang', 'Dibang Valley', 'East Kameng', 'East Siang', 'Kamle', 'Kra Daadi', 'Kurung Kumey', 'Lepa Rada', 'Lohit', 'Longding', 'Lower Dibang Valley', 'Lower Siang', 'Lower Subansiri', 'Namsai', 'Pakke Kessang', 'Papum Pare', 'Shi Yomi', 'Siang', 'Tawang', 'Tirap', 'Upper Siang', 'Upper Subansiri', 'West Kameng', 'West Siang'],
            'Assam': ['Baksa', 'Barpeta', 'Biswanath', 'Bongaigaon', 'Cachar', 'Charaideo', 'Chirang', 'Darrang', 'Dhemaji', 'Dhubri', 'Dibrugarh', 'Dima Hasao', 'Goalpara', 'Golaghat', 'Hailakandi', 'Hojai', 'Jorhat', 'Kamrup', 'Kamrup Metropolitan', 'Karbi Anglong', 'Karimganj', 'Kokrajhar', 'Lakhimpur', 'Majuli', 'Morigaon', 'Nagaon', 'Nalbari', 'Sivasagar', 'Sonitpur', 'South Salmara-Mankachar', 'Tinsukia', 'Udalguri', 'West Karbi Anglong'],
            'Bihar': ['Araria', 'Arwal', 'Aurangabad', 'Banka', 'Begusarai', 'Bhagalpur', 'Bhojpur', 'Buxar', 'Darbhanga', 'East Champaran', 'Gaya', 'Gopalganj', 'Jamui', 'Jehanabad', 'Kaimur', 'Katihar', 'Khagaria', 'Kishanganj', 'Lakhisarai', 'Madhepura', 'Madhubani', 'Munger', 'Muzaffarpur', 'Nalanda', 'Nawada', 'Patna', 'Purnia', 'Rohtas', 'Saharsa', 'Samastipur', 'Saran', 'Sheikhpura', 'Sheohar', 'Sitamarhi', 'Siwan', 'Supaul', 'Vaishali', 'West Champaran'],
            'Chhattisgarh': ['Balod', 'Baloda Bazar', 'Balrampur', 'Bastar', 'Bemetara', 'Bijapur', 'Bilaspur', 'Dantewada', 'Dhamtari', 'Durg', 'Gariaband', 'Janjgir-Champa', 'Jashpur', 'Kabirdham', 'Kanker', 'Kondagaon', 'Korba', 'Koriya', 'Mahasamund', 'Mungeli', 'Narayanpur', 'Raigarh', 'Raipur', 'Rajnandgaon', 'Sukma', 'Surajpur', 'Surguja'],
            'Goa': ['North Goa', 'South Goa'],
            'Gujarat': ['Ahmedabad', 'Amreli', 'Anand', 'Aravalli', 'Banaskantha', 'Bharuch', 'Bhavnagar', 'Botad', 'Chhota Udaipur', 'Dahod', 'Dang', 'Devbhoomi Dwarka', 'Gandhinagar', 'Gir Somnath', 'Jamnagar', 'Junagadh', 'Kheda', 'Kutch', 'Mahisagar', 'Mehsana', 'Morbi', 'Narmada', 'Navsari', 'Panchmahal', 'Patan', 'Porbandar', 'Rajkot', 'Sabarkantha', 'Surat', 'Surendranagar', 'Tapi', 'Vadodara', 'Valsad'],
            'Haryana': ['Ambala', 'Bhiwani', 'Charkhi Dadri', 'Faridabad', 'Fatehabad', 'Gurugram', 'Hisar', 'Jhajjar', 'Jind', 'Kaithal', 'Karnal', 'Kurukshetra', 'Mahendragarh', 'Nuh', 'Palwal', 'Panchkula', 'Panipat', 'Rewari', 'Rohtak', 'Sirsa', 'Sonipat', 'Yamunanagar'],
            'Himachal Pradesh': ['Bilaspur', 'Chamba', 'Hamirpur', 'Kangra', 'Kinnaur', 'Kullu', 'Lahaul and Spiti', 'Mandi', 'Shimla', 'Sirmaur', 'Solan', 'Una'],
            'Jharkhand': ['Bokaro', 'Chatra', 'Deoghar', 'Dhanbad', 'Dumka', 'East Singhbhum', 'Garhwa', 'Giridih', 'Godda', 'Gumla', 'Hazaribagh', 'Jamtara', 'Khunti', 'Koderma', 'Latehar', 'Lohardaga', 'Pakur', 'Palamu', 'Ramgarh', 'Ranchi', 'Sahibganj', 'Seraikela Kharsawan', 'Simdega', 'West Singhbhum'],
            'Karnataka': ['Bagalkot', 'Ballari', 'Belagavi', 'Bengaluru Rural', 'Bengaluru Urban', 'Bidar', 'Chamarajanagar', 'Chikballapur', 'Chikkamagaluru', 'Chitradurga', 'Dakshina Kannada', 'Davanagere', 'Dharwad', 'Gadag', 'Hassan', 'Haveri', 'Kalaburagi', 'Kodagu', 'Kolar', 'Koppal', 'Mandya', 'Mysuru', 'Raichur', 'Ramanagara', 'Shivamogga', 'Tumakuru', 'Udupi', 'Uttara Kannada', 'Vijayapura', 'Yadgir'],
            'Kerala': ['Alappuzha', 'Ernakulam', 'Idukki', 'Kannur', 'Kasaragod', 'Kollam', 'Kottayam', 'Kozhikode', 'Malappuram', 'Palakkad', 'Pathanamthitta', 'Thiruvananthapuram', 'Thrissur', 'Wayanad'],
            'Madhya Pradesh': ['Agar Malwa', 'Alirajpur', 'Anuppur', 'Ashoknagar', 'Balaghat', 'Barwani', 'Betul', 'Bhind', 'Bhopal', 'Burhanpur', 'Chhatarpur', 'Chhindwara', 'Damoh', 'Datia', 'Dewas', 'Dhar', 'Dindori', 'Guna', 'Gwalior', 'Harda', 'Hoshangabad', 'Indore', 'Jabalpur', 'Jhabua', 'Katni', 'Khandwa', 'Khargone', 'Mandla', 'Mandsaur', 'Morena', 'Narsinghpur', 'Neemuch', 'Panna', 'Raisen', 'Rajgarh', 'Ratlam', 'Rewa', 'Sagar', 'Satna', 'Sehore', 'Seoni', 'Shahdol', 'Shajapur', 'Sheopur', 'Shivpuri', 'Sidhi', 'Singrauli', 'Tikamgarh', 'Ujjain', 'Umaria', 'Vidisha'],
            'Maharashtra': ['Ahmednagar', 'Akola', 'Amravati', 'Aurangabad', 'Beed', 'Bhandara', 'Buldhana', 'Chandrapur', 'Dhule', 'Gadchiroli', 'Gondia', 'Hingoli', 'Jalgaon', 'Jalna', 'Kolhapur', 'Latur', 'Mumbai City', 'Mumbai Suburban', 'Nagpur', 'Nanded', 'Nandurbar', 'Nashik', 'Osmanabad', 'Palghar', 'Parbhani', 'Pune', 'Raigad', 'Ratnagiri', 'Sangli', 'Satara', 'Sindhudurg', 'Solapur', 'Thane', 'Wardha', 'Washim', 'Yavatmal'],
            'Manipur': ['Bishnupur', 'Chandel', 'Churachandpur', 'Imphal East', 'Imphal West', 'Jiribam', 'Kakching', 'Kamjong', 'Kangpokpi', 'Noney', 'Pherzawl', 'Senapati', 'Tamenglong', 'Tengnoupal', 'Thoubal', 'Ukhrul'],
            'Meghalaya': ['East Garo Hills', 'East Jaintia Hills', 'East Khasi Hills', 'North Garo Hills', 'Ri Bhoi', 'South Garo Hills', 'South West Garo Hills', 'South West Khasi Hills', 'West Garo Hills', 'West Jaintia Hills', 'West Khasi Hills'],
            'Mizoram': ['Aizawl', 'Champhai', 'Hnahthial', 'Khawzawl', 'Kolasib', 'Lawngtlai', 'Lunglei', 'Mamit', 'Saiha', 'Saitual', 'Serchhip'],
            'Nagaland': ['Dimapur', 'Kiphire', 'Kohima', 'Longleng', 'Mokokchung', 'Mon', 'Peren', 'Phek', 'Tuensang', 'Wokha', 'Zunheboto'],
            'Odisha': ['Angul', 'Balangir', 'Balasore', 'Bargarh', 'Bhadrak', 'Boudh', 'Cuttack', 'Deogarh', 'Dhenkanal', 'Gajapati', 'Ganjam', 'Jagatsinghpur', 'Jajpur', 'Jharsuguda', 'Kalahandi', 'Kandhamal', 'Kendrapara', 'Kendujhar', 'Khordha', 'Koraput', 'Malkangiri', 'Mayurbhanj', 'Nabarangpur', 'Nayagarh', 'Nuapada', 'Puri', 'Rayagada', 'Sambalpur', 'Subarnapur', 'Sundargarh'],
            'Punjab': ['Amritsar', 'Barnala', 'Bathinda', 'Faridkot', 'Fatehgarh Sahib', 'Fazilka', 'Ferozepur', 'Gurdaspur', 'Hoshiarpur', 'Jalandhar', 'Kapurthala', 'Ludhiana', 'Mansa', 'Moga', 'Muktsar', 'Pathankot', 'Patiala', 'Rupnagar', 'Sahibzada Ajit Singh Nagar', 'Sangrur', 'Shahid Bhagat Singh Nagar', 'Tarn Taran'],
            'Rajasthan': ['Ajmer', 'Alwar', 'Banswara', 'Baran', 'Barmer', 'Bharatpur', 'Bhilwara', 'Bikaner', 'Bundi', 'Chittorgarh', 'Churu', 'Dausa', 'Dholpur', 'Dungarpur', 'Hanumangarh', 'Jaipur', 'Jaisalmer', 'Jalore', 'Jhalawar', 'Jhunjhunu', 'Jodhpur', 'Karauli', 'Kota', 'Nagaur', 'Pali', 'Pratapgarh', 'Rajsamand', 'Sawai Madhopur', 'Sikar', 'Sirohi', 'Sri Ganganagar', 'Tonk', 'Udaipur'],
            'Sikkim': ['East Sikkim', 'North Sikkim', 'South Sikkim', 'West Sikkim'],
            'Tamil Nadu': ['Ariyalur', 'Chengalpattu', 'Chennai', 'Coimbatore', 'Cuddalore', 'Dharmapuri', 'Dindigul', 'Erode', 'Kallakurichi', 'Kancheepuram', 'Karur', 'Krishnagiri', 'Madurai', 'Mayiladuthurai', 'Nagapattinam', 'Namakkal', 'Perambalur', 'Pudukkottai', 'Ramanathapuram', 'Ranipet', 'Salem', 'Sivaganga', 'Tenkasi', 'Thanjavur', 'Theni', 'Thoothukudi', 'Tiruchirappalli', 'Tirunelveli', 'Tirupathur', 'Tiruppur', 'Tiruvallur', 'Tiruvannamalai', 'Tiruvarur', 'Vellore', 'Viluppuram', 'Virudhunagar'],
            'Telangana': ['Adilabad', 'Bhadradri Kothagudem', 'Hyderabad', 'Jagtial', 'Jangaon', 'Jayashankar Bhupalpally', 'Jogulamba Gadwal', 'Kamareddy', 'Karimnagar', 'Khammam', 'Komaram Bheem Asifabad', 'Mahabubabad', 'Mahabubnagar', 'Mancherial', 'Medak', 'Medchal-Malkajgiri', 'Mulugu', 'Nagarkurnool', 'Nalgonda', 'Narayanpet', 'Nirmal', 'Nizamabad', 'Peddapalli', 'Rajanna Sircilla', 'Rangareddy', 'Sangareddy', 'Siddipet', 'Suryapet', 'Vikarabad', 'Wanaparthy', 'Warangal Rural', 'Warangal Urban', 'Yadadri Bhuvanagiri'],
            'Tripura': ['Dhalai', 'Gomati', 'Khowai', 'North Tripura', 'Sepahijala', 'South Tripura', 'Unakoti', 'West Tripura'],
            'Uttar Pradesh': ['Agra', 'Aligarh', 'Ambedkar Nagar', 'Amethi', 'Amroha', 'Auraiya', 'Ayodhya', 'Azamgarh', 'Baghpat', 'Bahraich', 'Ballia', 'Balrampur', 'Banda', 'Barabanki', 'Bareilly', 'Basti', 'Bhadohi', 'Bijnor', 'Budaun', 'Bulandshahr', 'Chandauli', 'Chitrakoot', 'Deoria', 'Etah', 'Etawah', 'Farrukhabad', 'Fatehpur', 'Firozabad', 'Gautam Buddha Nagar', 'Ghaziabad', 'Ghazipur', 'Gonda', 'Gorakhpur', 'Hamirpur', 'Hapur', 'Hardoi', 'Hathras', 'Jalaun', 'Jaunpur', 'Jhansi', 'Kannauj', 'Kanpur Dehat', 'Kanpur Nagar', 'Kasganj', 'Kaushambi', 'Kheri', 'Kushinagar', 'Lalitpur', 'Lucknow', 'Maharajganj', 'Mahoba', 'Mainpuri', 'Mathura', 'Mau', 'Meerut', 'Mirzapur', 'Moradabad', 'Muzaffarnagar', 'Pilibhit', 'Pratapgarh', 'Prayagraj', 'Raebareli', 'Rampur', 'Saharanpur', 'Sambhal', 'Sant Kabir Nagar', 'Shahjahanpur', 'Shamli', 'Shravasti', 'Siddharthnagar', 'Sitapur', 'Sonbhadra', 'Sultanpur', 'Unnao', 'Varanasi'],
            'Uttarakhand': ['Almora', 'Bageshwar', 'Chamoli', 'Champawat', 'Dehradun', 'Haridwar', 'Nainital', 'Pauri Garhwal', 'Pithoragarh', 'Rudraprayag', 'Tehri Garhwal', 'Udham Singh Nagar', 'Uttarkashi'],
            'West Bengal': ['Alipurduar', 'Bankura', 'Birbhum', 'Cooch Behar', 'Dakshin Dinajpur', 'Darjeeling', 'Hooghly', 'Howrah', 'Jalpaiguri', 'Jhargram', 'Kalimpong', 'Kolkata', 'Malda', 'Murshidabad', 'Nadia', 'North 24 Parganas', 'Paschim Bardhaman', 'Paschim Medinipur', 'Purba Bardhaman', 'Purba Medinipur', 'Purulia', 'South 24 Parganas', 'Uttar Dinajpur'],
            // Union Territories
            'Andaman and Nicobar Islands': ['Nicobar', 'North and Middle Andaman', 'South Andaman'],
            'Chandigarh': ['Chandigarh'],
            'Dadra and Nagar Haveli and Daman and Diu': ['Dadra and Nagar Haveli', 'Daman', 'Diu'],
            'Delhi': ['Central Delhi', 'East Delhi', 'New Delhi', 'North Delhi', 'North East Delhi', 'North West Delhi', 'Shahdara', 'South Delhi', 'South East Delhi', 'South West Delhi', 'West Delhi'],
            'Jammu and Kashmir': ['Anantnag', 'Bandipora', 'Baramulla', 'Budgam', 'Doda', 'Ganderbal', 'Jammu', 'Kathua', 'Kishtwar', 'Kulgam', 'Kupwara', 'Poonch', 'Pulwama', 'Rajouri', 'Ramban', 'Reasi', 'Samba', 'Shopian', 'Srinagar', 'Udhampur'],
            'Ladakh': ['Kargil', 'Leh'],
            'Lakshadweep': ['Lakshadweep'],
            'Puducherry': ['Karaikal', 'Mahe', 'Puducherry', 'Yanam']
        };

        // Initialize the map with default center in India (Delhi)
        const map = L.map('map').setView([20.5937, 78.9629], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Custom icons for markers
        const hospitalIcon = L.divIcon({
            html: '<i class="fas fa-hospital text-2xl text-red-600"></i>',
            className: 'custom-div-icon',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        const bloodBankIcon = L.divIcon({
            html: '<i class="fas fa-tint text-2xl text-red-600"></i>',
            className: 'custom-div-icon',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        // Hospital search and display functions
        async function searchHospitals() {
            const state = document.getElementById('state').value;
            const district = document.getElementById('district').value;
            const bloodType = document.getElementById('blood-type').value;

            if (!state || !district || !bloodType) {
                alert('Please select all fields');
                return;
            }

            showLoading(true);

            try {
                // Fetch district coordinates first
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?q=${district},${state},India&format=json&limit=1`;
                const locationResponse = await fetch(nominatimUrl);
                const locationData = await locationResponse.json();

                if (locationData.length === 0) {
                    throw new Error('Location not found');
                }

                const { lat, lon, boundingbox } = locationData[0];

                // Center and zoom map
                map.setView([lat, lon], 12);

                // Fetch hospitals and blood banks
                const overpassQuery = `
                    [out:json];
                    area[name="${district}"]->.searchArea;
                    (
                        node["amenity"="hospital"](area.searchArea);
                        node["healthcare"="blood_bank"](area.searchArea);
                    );
                    out body;
                `;

                const overpassUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`;
                const hospitalsResponse = await fetch(overpassUrl);
                const hospitalsData = await hospitalsResponse.json();

                // Clear existing markers and cards
                clearResults();

                // Process and display results
                if (hospitalsData.elements.length > 0) {
                    displayResults(hospitalsData.elements, bloodType);
                } else {
                    showNoResults();
                }

                // Also fetch donors for the selected state and render them
                try { await fetchDonorsByState(state); } catch (e) { console.warn('Donor fetch failed', e); }
            } catch (error) {
                console.error('Error fetching hospitals:', error);
                showError();
            } finally {
                showLoading(false);
            }
        }

        function displayResults(hospitals, bloodType) {
            const hospitalsList = document.getElementById('hospitals-list');

            hospitals.forEach(hospital => {
                // Add marker to map
                const marker = L.marker([hospital.lat, hospital.lon], {
                    icon: hospital.tags.healthcare === 'blood_bank' ? bloodBankIcon : hospitalIcon
                }).addTo(map);

                // Create popup content
                const popupContent = createPopupContent(hospital);
                marker.bindPopup(popupContent);

                // Create hospital card
                const card = createHospitalCard(hospital, bloodType);
                hospitalsList.appendChild(card);
            });

            document.getElementById('search-status').style.display = 'none';
        }

        function createPopupContent(hospital) {
            const name = hospital.tags.name || 'Unnamed Hospital';
            const address = hospital.tags.address || hospital.tags['addr:full'] || 'Address not available';
            const phone = hospital.tags.phone || 'N/A';

            return `
                <div class="p-2">
                    <h3 class="font-bold text-lg mb-2">${name}</h3>
                    <p class="text-sm mb-2">${address}</p>
                    <p class="text-sm mb-2">Phone: ${phone}</p>
                    <a href="https://www.google.com/maps?q=${hospital.lat},${hospital.lon}" 
                       target="_blank"
                       class="bg-red-500 text-white px-4 py-2 rounded text-sm inline-block hover:bg-red-600">
                        Get Directions
                    </a>
                </div>
            `;
        }

        function createHospitalCard(hospital, bloodType) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow';

            const name = hospital.tags.name || 'Unnamed Hospital';
            const address = hospital.tags.address || hospital.tags['addr:full'] || 'Address not available';
            const phone = hospital.tags.phone || 'N/A';

            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">${name}</h3>
                        <p class="text-sm text-gray-600 mt-1">${address}</p>
                    </div>
                    <div class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded">
                        ${hospital.tags.healthcare === 'blood_bank' ? 'Blood Bank' : 'Hospital'}
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-phone mr-2"></i>${phone}
                    </p>
                    <p class="text-sm text-gray-600 mt-1">
                        <i class="fas fa-tint mr-2"></i>Blood Type ${bloodType} Available
                    </p>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-2">
                    <button onclick="openRequestModal('${hospital.id}', '${bloodType}', '${name}', '${phone}')" 
                            class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700 transition-colors">
                        <i class="fas fa-tint mr-2"></i>Request Blood
                    </button>
                    <div class="flex space-x-2">
                        <a href="tel:${phone}" 
                           class="bg-gray-100 text-gray-800 px-3 py-2 rounded text-sm hover:bg-gray-200 flex-1 text-center">
                            <i class="fas fa-phone"></i>
                        </a>
                        <a href="https://www.google.com/maps?q=${hospital.lat},${hospital.lon}" 
                           target="_blank"
                           class="bg-gray-100 text-gray-800 px-3 py-2 rounded text-sm hover:bg-gray-200 flex-1 text-center">
                            <i class="fas fa-directions"></i>
                        </a>
                    </div>
                </div>
            `;

            return div;
        }

        function clearResults() {
            // Clear markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Clear hospital cards
            document.getElementById('hospitals-list').innerHTML = '';
        }

        function showLoading(show) {
            document.getElementById('loading-spinner').style.display = show ? 'block' : 'none';
            document.getElementById('search-status').style.display = show ? 'none' : 'block';
        }

        // Request Blood Modal Functions
        let currentHospital = null;

        function openRequestModal(hospitalId, bloodType, hospitalName, hospitalPhone) {
            currentHospital = {
                id: hospitalId,
                name: hospitalName,
                phone: hospitalPhone,
                bloodType: bloodType
            };

            // Set modal values
            document.getElementById('hospitalName').value = hospitalName;
            document.getElementById('requestBloodType').value = bloodType;

            // Set default required by time (current time + 2 hours)
            const now = new Date();
            now.setHours(now.getHours() + 2);
            document.getElementById('requiredBy').value = now.toISOString().slice(0, 16);

            // Show modal
            document.getElementById('requestModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeRequestModal() {
            document.getElementById('requestModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentHospital = null;
        }

        async function submitBloodRequest() {
            const patientId = document.body.dataset.patientId;
            const patientName = "<%= user.fullName %>";

            const units = parseInt(document.getElementById('units').value);
            const bloodGroup = currentHospital.bloodType;
            const hospitalName = currentHospital.name;
            const requiredBy = document.getElementById('requiredBy').value;
            const notes = document.getElementById('notes').value;
            const urgency = document.getElementById('urgency').value;

            if (!patientId) {
                Swal.fire("Error", "Patient ID missing", "error");
                return;
            }

            try {
                // ✅ Save new DEMO request
                const response = await fetch('/api/demo-request', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        patientId,
                        patientName,
                        hospitalName,
                        bloodGroup,
                        units,
                        requiredBy,
                        notes,
                        urgency
                    })
                });

                const result = await response.json();
                if (!result.success) throw new Error("Failed to save request");

                // ✅ Success Popup (your UI)
                await Swal.fire({
                    title: 'Request Submitted!',
                    text: `Your request for ${units} unit(s) of ${bloodGroup} has been received.`,
                    icon: 'success',
                    confirmButtonColor: '#EF4444',
                    confirmButtonText: 'View Requests',
                    showCancelButton: true,
                    cancelButtonText: 'Close',
                });

                closeRequestModal();

                // ✅ Redirect to My Requests page
                window.location.href = `/requests?patientId=${patientId}`;

            } catch (err) {
                console.error(err);
                Swal.fire("Error", "Could not submit request", "error");
            }
        }

        // Close modal when clicking outside
        document.getElementById('requestModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeRequestModal();
            }
        });

        function showNoResults() {
            const status = document.getElementById('search-status');
            status.innerHTML = `
                <div class="text-gray-400 mb-2">
                    <i class="fas fa-exclamation-circle text-4xl"></i>
                </div>
                <h4 class="text-lg font-medium text-gray-600">No Results Found</h4>
                <p class="text-sm text-gray-500">Try searching in a different area or with different criteria</p>
            `;
            status.style.display = 'block';
        }

        function showError() {
            const status = document.getElementById('search-status');
            status.innerHTML = `
                <div class="text-red-400 mb-2">
                    <i class="fas fa-exclamation-triangle text-4xl"></i>
                </div>
                <h4 class="text-lg font-medium text-red-600">Error</h4>
                <p class="text-sm text-gray-500">Unable to fetch results. Please try again later.</p>
            `;
            status.style.display = 'block';
        }

        // State to Districts mapping
        window.stateDistricts = {
            'Andhra Pradesh': ['Anantapur', 'Chittoor', 'East Godavari', 'Guntur', 'Krishna', 'Kurnool', 'Nellore', 'Prakasam', 'Srikakulam', 'Visakhapatnam', 'Vizianagaram', 'West Godavari', 'YSR Kadapa'],
            'Arunachal Pradesh': ['Anjaw', 'Changlang', 'Dibang Valley', 'East Kameng', 'East Siang', 'Kamle', 'Kra Daadi', 'Kurung Kumey', 'Lepa Rada', 'Lohit', 'Longding', 'Lower Dibang Valley', 'Lower Siang', 'Lower Subansiri', 'Namsai', 'Pakke Kessang', 'Papum Pare', 'Shi Yomi', 'Siang', 'Tawang', 'Tirap', 'Upper Siang', 'Upper Subansiri', 'West Kameng', 'West Siang'],
            'Assam': ['Baksa', 'Barpeta', 'Biswanath', 'Bongaigaon', 'Cachar', 'Charaideo', 'Chirang', 'Darrang', 'Dhemaji', 'Dhubri', 'Dibrugarh', 'Dima Hasao', 'Goalpara', 'Golaghat', 'Hailakandi', 'Hojai', 'Jorhat', 'Kamrup', 'Kamrup Metropolitan', 'Karbi Anglong', 'Karimganj', 'Kokrajhar', 'Lakhimpur', 'Majuli', 'Morigaon', 'Nagaon', 'Nalbari', 'Sivasagar', 'Sonitpur', 'South Salmara-Mankachar', 'Tinsukia', 'Udalguri', 'West Karbi Anglong'],
            'Bihar': ['Araria', 'Arwal', 'Aurangabad', 'Banka', 'Begusarai', 'Bhagalpur', 'Bhojpur', 'Buxar', 'Darbhanga', 'East Champaran', 'Gaya', 'Gopalganj', 'Jamui', 'Jehanabad', 'Kaimur', 'Katihar', 'Khagaria', 'Kishanganj', 'Lakhisarai', 'Madhepura', 'Madhubani', 'Munger', 'Muzaffarpur', 'Nalanda', 'Nawada', 'Patna', 'Purnia', 'Rohtas', 'Saharsa', 'Samastipur', 'Saran', 'Sheikhpura', 'Sheohar', 'Sitamarhi', 'Siwan', 'Supaul', 'Vaishali', 'West Champaran'],
            'Chhattisgarh': ['Balod', 'Baloda Bazar', 'Balrampur', 'Bastar', 'Bemetara', 'Bijapur', 'Bilaspur', 'Dantewada', 'Dhamtari', 'Durg', 'Gariaband', 'Janjgir-Champa', 'Jashpur', 'Kabirdham', 'Kanker', 'Kondagaon', 'Korba', 'Koriya', 'Mahasamund', 'Mungeli', 'Narayanpur', 'Raigarh', 'Raipur', 'Rajnandgaon', 'Sukma', 'Surajpur', 'Surguja'],
            'Goa': ['North Goa', 'South Goa'],
            'Gujarat': ['Ahmedabad', 'Amreli', 'Anand', 'Aravalli', 'Banaskantha', 'Bharuch', 'Bhavnagar', 'Botad', 'Chhota Udaipur', 'Dahod', 'Dang', 'Devbhoomi Dwarka', 'Gandhinagar', 'Gir Somnath', 'Jamnagar', 'Junagadh', 'Kheda', 'Kutch', 'Mahisagar', 'Mehsana', 'Morbi', 'Narmada', 'Navsari', 'Panchmahal', 'Patan', 'Porbandar', 'Rajkot', 'Sabarkantha', 'Surat', 'Surendranagar', 'Tapi', 'Vadodara', 'Valsad'],
            'Haryana': ['Ambala', 'Bhiwani', 'Charkhi Dadri', 'Faridabad', 'Fatehabad', 'Gurugram', 'Hisar', 'Jhajjar', 'Jind', 'Kaithal', 'Karnal', 'Kurukshetra', 'Mahendragarh', 'Nuh', 'Palwal', 'Panchkula', 'Panipat', 'Rewari', 'Rohtak', 'Sirsa', 'Sonipat', 'Yamunanagar'],
            'Himachal Pradesh': ['Bilaspur', 'Chamba', 'Hamirpur', 'Kangra', 'Kinnaur', 'Kullu', 'Lahaul and Spiti', 'Mandi', 'Shimla', 'Sirmaur', 'Solan', 'Una'],
            'Jharkhand': ['Bokaro', 'Chatra', 'Deoghar', 'Dhanbad', 'Dumka', 'East Singhbhum', 'Garhwa', 'Giridih', 'Godda', 'Gumla', 'Hazaribagh', 'Jamtara', 'Khunti', 'Koderma', 'Latehar', 'Lohardaga', 'Pakur', 'Palamu', 'Ramgarh', 'Ranchi', 'Sahibganj', 'Seraikela Kharsawan', 'Simdega', 'West Singhbhum'],
            'Karnataka': ['Bagalkot', 'Ballari', 'Belagavi', 'Bengaluru Rural', 'Bengaluru Urban', 'Bidar', 'Chamarajanagar', 'Chikballapur', 'Chikkamagaluru', 'Chitradurga', 'Dakshina Kannada', 'Davanagere', 'Dharwad', 'Gadag', 'Hassan', 'Haveri', 'Kalaburagi', 'Kodagu', 'Kolar', 'Koppal', 'Mandya', 'Mysuru', 'Raichur', 'Ramanagara', 'Shivamogga', 'Tumakuru', 'Udupi', 'Uttara Kannada', 'Vijayapura', 'Yadgir'],
            'Kerala': ['Alappuzha', 'Ernakulam', 'Idukki', 'Kannur', 'Kasaragod', 'Kollam', 'Kottayam', 'Kozhikode', 'Malappuram', 'Palakkad', 'Pathanamthitta', 'Thiruvananthapuram', 'Thrissur', 'Wayanad'],
            'Madhya Pradesh': ['Agar Malwa', 'Alirajpur', 'Anuppur', 'Ashoknagar', 'Balaghat', 'Barwani', 'Betul', 'Bhind', 'Bhopal', 'Burhanpur', 'Chhatarpur', 'Chhindwara', 'Damoh', 'Datia', 'Dewas', 'Dhar', 'Dindori', 'Guna', 'Gwalior', 'Harda', 'Hoshangabad', 'Indore', 'Jabalpur', 'Jhabua', 'Katni', 'Khandwa', 'Khargone', 'Mandla', 'Mandsaur', 'Morena', 'Narsinghpur', 'Neemuch', 'Panna', 'Raisen', 'Rajgarh', 'Ratlam', 'Rewa', 'Sagar', 'Satna', 'Sehore', 'Seoni', 'Shahdol', 'Shajapur', 'Sheopur', 'Shivpuri', 'Sidhi', 'Singrauli', 'Tikamgarh', 'Ujjain', 'Umaria', 'Vidisha'],
            'Maharashtra': ['Ahmednagar', 'Akola', 'Amravati', 'Aurangabad', 'Beed', 'Bhandara', 'Buldhana', 'Chandrapur', 'Dhule', 'Gadchiroli', 'Gondia', 'Hingoli', 'Jalgaon', 'Jalna', 'Kolhapur', 'Latur', 'Mumbai City', 'Mumbai Suburban', 'Nagpur', 'Nanded', 'Nandurbar', 'Nashik', 'Osmanabad', 'Palghar', 'Parbhani', 'Pune', 'Raigad', 'Ratnagiri', 'Sangli', 'Satara', 'Sindhudurg', 'Solapur', 'Thane', 'Wardha', 'Washim', 'Yavatmal'],
            'Manipur': ['Bishnupur', 'Chandel', 'Churachandpur', 'Imphal East', 'Imphal West', 'Jiribam', 'Kakching', 'Kamjong', 'Kangpokpi', 'Noney', 'Pherzawl', 'Senapati', 'Tamenglong', 'Tengnoupal', 'Thoubal', 'Ukhrul'],
            'Meghalaya': ['East Garo Hills', 'East Jaintia Hills', 'East Khasi Hills', 'North Garo Hills', 'Ri Bhoi', 'South Garo Hills', 'South West Garo Hills', 'South West Khasi Hills', 'West Garo Hills', 'West Jaintia Hills', 'West Khasi Hills'],
            'Mizoram': ['Aizawl', 'Champhai', 'Hnahthial', 'Khawzawl', 'Kolasib', 'Lawngtlai', 'Lunglei', 'Mamit', 'Saiha', 'Saitual', 'Serchhip'],
            'Nagaland': ['Dimapur', 'Kiphire', 'Kohima', 'Longleng', 'Mokokchung', 'Mon', 'Peren', 'Phek', 'Tuensang', 'Wokha', 'Zunheboto'],
            'Odisha': ['Angul', 'Balangir', 'Balasore', 'Bargarh', 'Bhadrak', 'Boudh', 'Cuttack', 'Deogarh', 'Dhenkanal', 'Gajapati', 'Ganjam', 'Jagatsinghpur', 'Jajpur', 'Jharsuguda', 'Kalahandi', 'Kandhamal', 'Kendrapara', 'Kendujhar', 'Khordha', 'Koraput', 'Malkangiri', 'Mayurbhanj', 'Nabarangpur', 'Nayagarh', 'Nuapada', 'Puri', 'Rayagada', 'Sambalpur', 'Subarnapur', 'Sundargarh'],
            'Punjab': ['Amritsar', 'Barnala', 'Bathinda', 'Faridkot', 'Fatehgarh Sahib', 'Fazilka', 'Ferozepur', 'Gurdaspur', 'Hoshiarpur', 'Jalandhar', 'Kapurthala', 'Ludhiana', 'Mansa', 'Moga', 'Muktsar', 'Pathankot', 'Patiala', 'Rupnagar', 'Sahibzada Ajit Singh Nagar', 'Sangrur', 'Shahid Bhagat Singh Nagar', 'Tarn Taran'],
            'Rajasthan': ['Ajmer', 'Alwar', 'Banswara', 'Baran', 'Barmer', 'Bharatpur', 'Bhilwara', 'Bikaner', 'Bundi', 'Chittorgarh', 'Churu', 'Dausa', 'Dholpur', 'Dungarpur', 'Hanumangarh', 'Jaipur', 'Jaisalmer', 'Jalore', 'Jhalawar', 'Jhunjhunu', 'Jodhpur', 'Karauli', 'Kota', 'Nagaur', 'Pali', 'Pratapgarh', 'Rajsamand', 'Sawai Madhopur', 'Sikar', 'Sirohi', 'Sri Ganganagar', 'Tonk', 'Udaipur'],
            'Sikkim': ['East Sikkim', 'North Sikkim', 'South Sikkim', 'West Sikkim'],
            'Tamil Nadu': ['Ariyalur', 'Chengalpattu', 'Chennai', 'Coimbatore', 'Cuddalore', 'Dharmapuri', 'Dindigul', 'Erode', 'Kallakurichi', 'Kancheepuram', 'Karur', 'Krishnagiri', 'Madurai', 'Mayiladuthurai', 'Nagapattinam', 'Namakkal', 'Nilgiris', 'Perambalur', 'Pudukkottai', 'Ramanathapuram', 'Ranipet', 'Salem', 'Sivaganga', 'Tenkasi', 'Thanjavur', 'Theni', 'Thoothukudi', 'Tiruchirappalli', 'Tirunelveli', 'Tirupathur', 'Tiruppur', 'Tiruvallur', 'Tiruvannamalai', 'Tiruvarur', 'Vellore', 'Viluppuram', 'Virudhunagar'],
            'Telangana': ['Adilabad', 'Bhadradri Kothagudem', 'Hyderabad', 'Jagtial', 'Jangaon', 'Jayashankar Bhupalpally', 'Jogulamba Gadwal', 'Kamareddy', 'Karimnagar', 'Khammam', 'Komaram Bheem Asifabad', 'Mahabubabad', 'Mahabubnagar', 'Mancherial', 'Medak', 'Medchal-Malkajgiri', 'Mulugu', 'Nagarkurnool', 'Nalgonda', 'Narayanpet', 'Nirmal', 'Nizamabad', 'Peddapalli', 'Rajanna Sircilla', 'Rangareddy', 'Sangareddy', 'Siddipet', 'Suryapet', 'Vikarabad', 'Wanaparthy', 'Warangal Rural', 'Warangal Urban', 'Yadadri Bhuvanagiri'],
            'Tripura': ['Dhalai', 'Gomati', 'Khowai', 'North Tripura', 'Sepahijala', 'South Tripura', 'Unakoti', 'West Tripura'],
            'Uttar Pradesh': ['Agra', 'Aligarh', 'Ambedkar Nagar', 'Amethi', 'Amroha', 'Auraiya', 'Ayodhya', 'Azamgarh', 'Baghpat', 'Bahraich', 'Ballia', 'Balrampur', 'Banda', 'Barabanki', 'Bareilly', 'Basti', 'Bhadohi', 'Bijnor', 'Budaun', 'Bulandshahr', 'Chandauli', 'Chitrakoot', 'Deoria', 'Etah', 'Etawah', 'Farrukhabad', 'Fatehpur', 'Firozabad', 'Gautam Buddha Nagar', 'Ghaziabad', 'Ghazipur', 'Gonda', 'Gorakhpur', 'Hamirpur', 'Hapur', 'Hardoi', 'Hathras', 'Jalaun', 'Jaunpur', 'Jhansi', 'Kannauj', 'Kanpur Dehat', 'Kanpur Nagar', 'Kasganj', 'Kaushambi', 'Kheri', 'Kushinagar', 'Lalitpur', 'Lucknow', 'Maharajganj', 'Mahoba', 'Mainpuri', 'Mathura', 'Mau', 'Meerut', 'Mirzapur', 'Moradabad', 'Muzaffarnagar', 'Pilibhit', 'Pratapgarh', 'Prayagraj', 'Raebareli', 'Rampur', 'Saharanpur', 'Sambhal', 'Sant Kabir Nagar', 'Shahjahanpur', 'Shamli', 'Shravasti', 'Siddharthnagar', 'Sitapur', 'Sonbhadra', 'Sultanpur', 'Unnao', 'Varanasi'],
            'Uttarakhand': ['Almora', 'Bageshwar', 'Chamoli', 'Champawat', 'Dehradun', 'Haridwar', 'Nainital', 'Pauri Garhwal', 'Pithoragarh', 'Rudraprayag', 'Tehri Garhwal', 'Udham Singh Nagar', 'Uttarkashi'],
            'West Bengal': ['Alipurduar', 'Bankura', 'Birbhum', 'Cooch Behar', 'Dakshin Dinajpur', 'Darjeeling', 'Hooghly', 'Howrah', 'Jalpaiguri', 'Jhargram', 'Kalimpong', 'Kolkata', 'Malda', 'Murshidabad', 'Nadia', 'North 24 Parganas', 'Paschim Bardhaman', 'Paschim Medinipur', 'Purba Bardhaman', 'Purba Medinipur', 'Purulia', 'South 24 Parganas', 'Uttar Dinajpur'],
            // Union Territories
            'Andaman and Nicobar Islands': ['Nicobar', 'North and Middle Andaman', 'South Andaman'],
            'Chandigarh': ['Chandigarh'],
            'Dadra and Nagar Haveli and Daman and Diu': ['Dadra and Nagar Haveli', 'Daman', 'Diu'],
            'Delhi': ['Central Delhi', 'East Delhi', 'New Delhi', 'North Delhi', 'North East Delhi', 'North West Delhi', 'Shahdara', 'South Delhi', 'South East Delhi', 'South West Delhi', 'West Delhi'],
            'Jammu and Kashmir': ['Anantnag', 'Bandipora', 'Baramulla', 'Budgam', 'Doda', 'Ganderbal', 'Jammu', 'Kathua', 'Kishtwar', 'Kulgam', 'Kupwara', 'Poonch', 'Pulwama', 'Rajouri', 'Ramban', 'Reasi', 'Samba', 'Shopian', 'Srinagar', 'Udhampur'],
            'Ladakh': ['Kargil', 'Leh'],
            'Lakshadweep': ['Lakshadweep'],
            'Puducherry': ['Karaikal', 'Mahe', 'Puducherry', 'Yanam']
        };

        // Function to populate districts based on selected state
        function populateDistricts() {
            const stateSelect = document.getElementById('state');
            const districtSelect = document.getElementById('district');
            const selectedState = stateSelect.value;

            // Clear existing options
            districtSelect.innerHTML = '<option value="">Select District</option>';

            if (selectedState && window.stateDistricts[selectedState]) {
                // Enable district select
                districtSelect.disabled = false;

                // Add district options
                const districts = window.stateDistricts[selectedState];
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            } else {
                // Disable district select if no state is selected
                districtSelect.disabled = true;
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            // Add event listener for state selection change
            const stateSelect = document.getElementById('state');
            if (stateSelect) {
                stateSelect.addEventListener('change', populateDistricts);

                // Trigger change event if a state is already selected
                if (stateSelect.value) {
                    stateSelect.dispatchEvent(new Event('change'));
                }
            }

            // Add event listener for search button
            document.getElementById('searchHospitalsBtn').addEventListener('click', searchHospitals);
        });
    </script>
    <script>
        // Add this to your existing scripts
        document.getElementById('state').addEventListener('change', async function () {
            const state = this.value;
            const districtSelect = document.getElementById('district');

            // Clear existing options
            districtSelect.innerHTML = '<option value="">Select District</option>';

            if (!state) return;

            try {
                const response = await fetch(`/api/districts/${state}`);
                const districts = await response.json();

                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching districts:', error);
            }
        });
    </script>
</body>

</html>